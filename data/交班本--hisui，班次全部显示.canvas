{
	"nodes":[
		{"id":"a2bf993f31433899","type":"group","x":-425,"y":-320,"width":290,"height":780,"color":"2","label":"过程"},
		{"id":"93fad28d66d03349","type":"group","x":-760,"y":-320,"width":290,"height":220,"color":"1","label":"修改"},
		{"id":"057257e247dc1548","type":"text","text":"```\n/// 获取指定病区，指定日期的班次\n/// ##class(Nur.Custom.NeedUnit.NeedUnit231010).GetShiftConfig(39,\"2023-10-11\")\nClassMethod GetShiftConfig(WardId, DateH)\n{\n\ts dateL = ##Class(websys.Conversions).DateHtmlToLogical(DateH)\n\t//获得交班业务数据 id\n\ts shiftRecordRid = ##class(Nur.SHIFT.Service.ShiftBizV2).GetMainDR(WardId,dateL)\n\t//获得班次\n\ts resule = \"\"\n\ts shiftRecordSid = \"0\" f{\n\t\ts shiftRecordSid = $o(^Nur.SHIFT.ShiftRecord(shiftRecordRid,\"C\",shiftRecordSid))\n\t\tq:shiftRecordSid=\"\"\n\t\ts val = shiftRecordRid_\"||\"_shiftRecordSid\n\t\ts resule = $s(resule=\"\":val,1:resule_\"^\"_val)\n\t}\n\tq resule\n}\n```","x":-100,"y":-100,"width":740,"height":130},
		{"id":"1f9f9a1033a41605","type":"text","text":"新增csp，拷贝源代码\n方便修改","x":-405,"y":-210,"width":250,"height":60},
		{"id":"55b27e3f35deef32","type":"text","text":"远程号","x":-405,"y":-300,"width":250,"height":60},
		{"id":"725192ab3065ebad","type":"text","text":"csp\nnur.shift.index.showAll.csp","x":-740,"y":-300,"width":250,"height":60},
		{"id":"62e5bbf6fd3e5e6b","type":"text","text":"cls","x":-740,"y":-180,"width":250,"height":60},
		{"id":"a340ef5a9d1d186d","type":"text","text":"```\n<csp:method name=OnPreHTTP arguments=\"\" returntype=%Boolean>  \n     i ##Class(websys.SessionEvents).SessionExpired() q 1  \n    q 1  \n</csp:method>  \n  \n<html>  \n<head>  \n  \n<!-- Put your page Title here -->  \n<meta charset=\"utf-8\"/>  \n<title>交班本</title>  \n<script language=\"cache\" runat=\"SERVER\">  \ns chromePrintFlag=\"false\"  \ns emrPrintFlag=1  \n</script>  \n<!-- <csp:if condition='chromePrintFlag=\"true\"'>  \n      <script type=\"text/javascript\" src=\"../scripts/nurse/hisui-0.1.0/dist/js/PrintProvider.js\">  \n      </script>  \n      <script type=\"text/javascript\" src=\"../scripts/nurse/hisui-0.1.0/dist/js/Common.js\">  \n      </script>  \n      <csp:if condition=\"emrPrintFlag=1\">  \n        <addins require=\"NurEmrPrint\"></addins>  \n      </csp:if>  \n    </csp:if>  \n    <csp:if condition='chromePrintFlag=\"false\"'>  \n      <csp:if condition=\"emrPrintFlag=1\">  \n        <ainurprint></ainurprint>  \n      </csp:if>  \n    </csp:if> -->  \n  \n<!--判断病历是否兼容Chrome和IE打印 start-->  \n<script language=\"cache\" runat=\"SERVER\">  \n // init Chrome print  \n d ##class(NurMp.Config).WriteChromePrintCompatibleADDINS()  \n</script>  \n<!-- init IE print -->  \n<ainurprint></ainurprint>  \n<!-- end -->  \n  \n    <EXTHEALTH:HEAD></EXTHEALTH:HEAD>  \n    <HISUI />  \n    <style>  \n     body{opacity: 0; transition: opacity 0.2s}  \n        body.active{opacity: 1}  \n     body  \n     {  \n     min-height:500px;  \n     overflow-y: hidden;  \n    }  \n.panel{  \nmargin-top:0;  \n}  \n.summary{  \nmargin-left:10px;  \nmargin-top:5px;  \nfloat:left;  \nwidth:98%;  \nbackground: #fff;  \npadding:3px 0px;  \n}  \n.radusBorder{  \n  \n-moz-border-radius: 2px;  \n-webkit-border-radius: 2px;  \nborder-radius: 2px;  \n  \npadding:1px 2px;  \nmargin-right:2px;  \npadding: 5px;  \ndisplay: block;  \n    text-align: center;  \n    font-size: 14px;  \n    font-weight:bold;  \n}  \n.rbDay  \n{  \nborder-color: #0096F2;  \nbackground:#EBF6FE;  \ncolor:#0096F2;  \n}  \n.rbSNight  \n{  \nborder-color: #FF0000;  \nbackground:#FFE2E2;  \ncolor:#FF0000;  \n}  \n.rbBNight  \n{  \nborder-color: #C90634;  \nbackground:#FFD6E6;  \ncolor:#C90634;  \n}  \n.summary:hover{  \nbackground:#bce3ff;  \ncursor:pointer;  \n}  \n.title{  \nmargin-left:170px;  \n}  \n.title span{  \nmargin-left:10px;  \nfont-weight:bolder;  \ndisplay:block;  \nfloat:left;  \nword-break:keep-all;  \nwhite-space:nowrap;  \noverflow:hidden;  \ntext-overflow:ellipsis;  \n-o-text-overflow:ellipsis;  \n-icab-text-overflow:ellipsis;  \n-khtml-text-overflow:ellipsis;  \n-moz-text-overflow: ellipsis;  \n-webkit-text-overflow:ellipsis;  \n}  \n.summary span{  \nmargin-left:10px;  \nfont-weight:bolder;  \ndisplay:block;  \nfloat:left;  \n}  \n/*.datagrid-btable{  \nposition:fixed;  \n}*/  \ntd[field=_expander]{  \nborder-width:0 0 1px 1px;  \n}  \n/*.datagrid-btable{  \nposition:relative;  \n}*/  \n#tool{  \nmargin-top:3px;  \n}  \n#bottom{  \nwidth:100%;  \n}  \n#bleft{  \nfloat:left;  \nwidth:105px;  \nheight:100%;  \noverflow-y: hidden;  \n}  \n#bleft .itemArea{  \nheight:calc(100% - 32px);  \noverflow-y:auto;  \n}  \n#bleft .itemArea .tab:last-child{  \nborder:0;  \n}  \n#bright{  \nmargin-left:105px;  \n}  \n.tabBak{  \nborder: 1px solid;  \nborder-right:none;  \nborder-top:none;  \n-moz-border-top-left-radius: 4px;  \n-moz-border-bottom-left-radius: 4px;  \n-webkit-border-top-left-radius: 4px;  \n-webkit-border-bottom-left-radius: 4px;  \nborder-top-left-radius:4px;  \nborder-bottom-left-radius:4px;  \nborder-color: #509de1;  \npadding:5px 1px 5px 5px;  \nfont-weight: bolder;  \nfont-size: 16px;  \n}  \n.tab{  \nposition:relative;  \nmargin: 0;  \npadding: 0 4px;  \nheight: 30px;  \nline-height:30px;  \nborder-collapse: separate;  \ntext-align: left;  \nfont-size: 14px;  \nwhite-space: nowrap;  \n     text-overflow: ellipsis;  \n      overflow: hidden;     \n      text-align:center;    \n}  \n.badge{  \nposition:absolute;  \ndisplay:inline-block;  \nheight:10px;  \nwidth:10px;  \nbackground-color:#ee4f38;  \ntext-align:center;  \ncolor:#fff;  \ntransform:translateY(-50%) translateX(100%);  \nfont-size:14px;  \nline-height:18px;  \nborder:1px solid transparent;  \ntop:0;  \nright:10px;  \n}  \n#bleft .itemArea .tab{  \nheight: 30px;  \nline-height:30px;  \nmargin: 4px;  \n     background-color: #f4f6f5;  \n     font-weight:bold;  \n}  \n.last-tab{  \nborder-width: 1px 1px 1px 1px;  \n}  \n#bleft .itemArea .tab:hover{  \nbackground:#cee4ff;  \ncursor:pointer;  \n  \n}  \n#bleft .itemArea .selectedItem,#bleft .itemArea .selectedItem:hover{  \n/*background-color:#bce3ff;*/  \nbackground-color:#40A2DE;  \ncolor:#fff;  \n}  \n#wardcombo+span{  \nfloat:right;  \n}  \n.opacity{  \nopacity:1;  \nheight:30px;  \n}  \n.opacity:hover{  \nopacity:1;  \n}  \n/* 中间区 */  \n.midArea{  \npadding:0 4px 10px 4px;  \nborder-bottom:1px solid #ddd;  \n}  \n.midArea .customRow{  \ndisplay:flex;  \npadding-top:10px;  \nmin-height:40px;  \nheight:40px;  \n}  \n.midArea .customRow .customItem{  \ndisplay:flex;  \nflex:1;  \nmargin-left:10px;  \nborder: 1px solid #ddd;  \n     background: #f4f6f5;  \n}  \n.midArea .customRow .customItem:first-child{  \npadding-left:0;  \n}  \n.midArea .customRow label{  \ntext-align: center;  \n    font-weight: bold;  \n    line-height: 40px;  \nwidth:87px;  \ntext-align:right;  \n}  \n.midArea .customRow .customItem div{  \npadding: 2px 4px;  \n      \n     border-radius: 2px;  \n     margin-left: 10px;  \n     line-height: 40px;  \n     min-height:22px;  \n     width:calc(100% - 107px);  \n     border-left:1px solid #ddd;  \n     border-radius:2px;  \n     background-color:#fff;  \n}  \n.midArea .customRow .customItem .editArea{  \npadding:0;  \nborder:0;  \nwidth:calc(100% - 97px);  \n}  \n.midArea .customRow .customItem .editArea textarea{  \nheight:100%;  \nborder:1px solid #9ed2f2;  \n}  \n/* 弹窗 */  \n#modalAddPatient .panel-body{  \nborder-color:#ddd;  \n}  \n/* 交班状态 */  \n.shiftStatus{  \ndisplay:inline-block;  \nwidth:16px;height:16px;  \nfloat:right;  \npadding:0 2px;  \n}  \n.icon-delete{  \nbackground:url(../images/uiimages/delete.svg) center no-repeat;  \n}  \n.icon-hidden{  \nbackground:url(../images/uiimages/hidden.svg) center no-repeat;  \n}  \n.icon-print{  \nbackground:url(../images/uiimages/print.png) right no-repeat;  \n}  \n/* 重置班次 */  \n.radioGroup{  \ndisplay:flex;  \n}  \n.radioGroup p{  \ncursor:pointer;  \n}  \nlabel.checkbox{  \nmargin-bottom:4px;  \n}  \nlabel.checkbox, label.hischeckbox_square-blue.radio{  \nbackground-position-x:-5px;  \n}  \n#modalSign .validatebox-text{  \nwidth:172px!important;  \n}  \n.dateArea{  \npadding:10px;  \npadding-bottom:0px;  \ndisplay:flex;  \nalign-items:center;  \n}  \n.dateArea a{  \nmargin-left:10px;  \n}  \n.shiftArea{  \n}  \n.shiftArea>.note{  \nwidth:30px;  \nbackground-color:#f4f6f5;  \ndisplay:flex;  \njustify-content:center;  \nalign-items:center;  \n}  \n.shiftArea>li:last-child{  \nwidth:calc(100% );  \n}  \n.shiftArea .datagrid-wrap,#bright .datagrid-wrap{  \nborder-top:0;  \nborder-right:0;  \nborder-bottom:0;  \nborder-color:#ddd;  \nborder-radius:0;  \n}  \n.shiftArea .datagrid-body tr:last-child td{  \nborder-bottom:0;  \n}  \n.datagrid-cell-c1-shiftName{  \npadding:0 4px;  \nwidth:100px !important;  \n}  \ntextarea:focus{  \nbox-shadow:none!important;  \n}  \n#bright .datagrid-htable td{  \nborder-bottom:0;  \n}  \n.messager-icon{  \nfloat: left;  \n     width: 32px;  \n     height: 32px;  \n     margin: 0 10px 10px 0;  \n}   \n.messager-question{  \nbackground: url(../images/uiimages/messager_icons.png) no-repeat scroll -32px 0;  \n}  \n.dateArea #rebuild{  \nbackground:url(../images/icon-set.png) 7px 7px no-repeat;  \n}  \n#main{  \nborder: 1px solid #ccc;  \nborder-radius: 4px;  \nheight:calc(100% - 38px);  \n}  \n#bright td[field=_expander]{  \nborder-left:0;  \n}  \n/* 修改记录弹窗 */  \n#modalModifyLog .combo-text{  \nwidth:83px!important;  \n}  \n#modalModifyLog #logList{  \nheight:calc(100% - 38px);  \n}  \n.operateType{  \ndisplay:none;  \n}  \n#modalModifyLog .operateType .combo-text{  \nwidth:43px!important;  \n}  \n.shiftPatients p{  \nline-height:20px;  \n}  \n#modalModifyLog .datagrid-wrap{  \nborder:0;  \n}  \nul.shiftArea table td{  \ntext-align:center;  \n}  \nul.shiftArea table.datagrid-htable td{  \nfont-weight:bold  \n}  \n.datagrid-row-over.datagrid-row td:hover, .datagrid-row td:hover{  \n  \n  \ncursor: pointer;  \n}  \n  \n  \n    </style>  \n    <script type=\"text/javascript\" src=\"../scripts_lib/hisui-0.1.0/dist/plugin/datagrid-scrollview.js\"></script>  \n</head>  \n  \n<body style=\"background-color:white;padding:4px 4px 0 4px;height:100%;overflow-y:hidden;\" onresize=\"resizeFresh()\">  \n<SCRIPT language=\"cache\" RUNAT=\"SERVER\">  \n  n (%request,%session,%response)  \n  s WardID=$G(%request.Data(\"WardID\",1))  \n  s:WardID=\"\" WardID=$g(%session.Data(\"LOGON.WARDID\"))  \n  s LocID=$G(%request.Data(\"LocID\",1))  \n  s:LocID=\"\" LocID=$g(%session.Data(\"LOGON.CTLOCID\"))  \n  s TJDate=$G(%request.Data(\"TJDate\",1))  \n  s ItemDR=$G(%request.Data(\"ItemDR\",1))  \n  s ShiftType=$G(%request.Data(\"ShiftType\",1))  \n  s ShowAll=$G(%request.Data(\"ShowAll\",1))  \n  if TJDate=\"\"  \n  {  \ns shiftInfo=##class(Nur.SHIFT.Service.ShiftBizV2).GetClsRecord(WardID,$h)  \ns TJDate=$lg(shiftInfo,1)  \n  s ShiftType=$lg(shiftInfo,2)  \n}else  \n  {  \n  if ShiftType=\"\"  \n  {  \n  s TJDate=##class(websys.Conversions).DateHtmlToLogical(TJDate)  \ns mainDR=##class(Nur.SHIFT.Service.ShiftBizV2).GetMainDR(WardID,TJDate)  \ns clsSub=$o(^Nur.SHIFT.ShiftRecord(mainDR,\"C\",0))  \ns ShiftType=$p(^Nur.SHIFT.ShiftRecord(mainDR,\"C\",clsSub),\"^\",1)  \n}  \n}  \n  s jsDate=##class(websys.Conversions).DateLogicalToHtml(TJDate)  \n  s ifSignCA=$g(^CF.NUR.SHIFT.Config(\"SIGNCA\"))  \n  w \" <script type=\"\"text/javascript\"\" >var locID=\"_LocID_\";var wardID=\"_WardID_\";var tjDate=\"\"\"_jsDate_\"\"\";var shiftType=\"\"\"_ShiftType_\"\"\";var itemSelect=\"\"\"_ItemDR_\"\"\";var showAll=\"\"\"_ShowAll_\"\"\";var ifSignCA=\"\"\"_ifSignCA_\"\"\";<\"_\"/\"_\"script>\"  \n</SCRIPT>  \n<div class=\"wrap\" style=\"overflow: hidden;height:100%;\">  \n<!--上面按钮-->  \n<div id=\"main\" >  \n<div class=\"dateArea\">  \n<span style=\"display:inline-block;padding-right:10px;\">#(..Get(\"交班日期\"))#</span><input id=\"datecombo\" type=\"text\">  \n<a href=\"#\" class=\"hisui-linkbutton\" onclick=\"openModal('modalSign')\">交班</a>  \n<a href=\"#\" class=\"hisui-linkbutton\" onclick=\"PrintNormal()\">打印</a>  \n<a href=\"#\" class=\"hisui-linkbutton red\" onclick=\"AbolishSign()\">撤销签名</a>  \n<a href=\"#\" class=\"hisui-linkbutton\" onclick=\"openModifyLog()\">修改记录</a>  \n<a href=\"#\" class=\"hisui-linkbutton\" onclick=\"saveShiftContent()\">保存</a>  \n<a id=\"rebuild\" class=\"hisui-linkbutton small\"></a>  \n<input id=\"wardcombo\" style=\"display:none\">  \n<div class=\"opacity\" style=\"display:flex;height:30px;justify-content:flex-end;align-items:center;position: absolute;right: 1px;\">  \n<div style=\"width:300px;\">  \n<span style=\"color:#8D8D8D;\">#(..Get(\"交班护士：\"))#</span><span id=\"sign\" style=\"text-decoration:underline\"></span>  \n</div>  \n<div style=\"width:300px;\">  \n<span style=\"color:#8D8D8D;\">#(..Get(\"接班护士：\"))#</span><span id=\"sign2\" style=\"text-decoration:underline\"></span>  \n</div>  \n<div style=\"width:300px;float:left;display:none\">  \n<span style=\"color:#8D8D8D;\">#(..Get(\"护士长签名：\"))#</span><span id=\"signM\" style=\"text-decoration:underline\"></span>  \n</div>  \n</div>  \n</div>  \n<!--上面统计区-->  \n<div style=\"padding:10px;padding-bottom: 0px;\">  \n<ul class=\"shiftArea\" style=\"border:1px solid #ddd;border-left:0px;\">  \n<li class=\"note\" style=\"display:none;\">患<br>者</br>统</br>计</li>  \n<li><table id=\"tableC\"></table></li>  \n</ul>  \n</div>  \n<!--统计中间区-->  \n<div class=\"midArea\">  \n<SCRIPT language=\"cache\" RUNAT=\"SERVER\">  \nd ##class(Nur.SHIFT.Service.ShiftBizV2).GetMiddleInfo(WardID,TJDate,ShiftType,.rs)  \ns row=\"\" f  s row=$o(rs(row)) q:row=\"\"  d  \n.w \"<div class='customRow'>\"  \n.s col=\"\" f  s col=$o(rs(row,col)) q:col=\"\"  d  \n..s mid=$g(rs(row,col,\"id\"))  \n..s mname=$g(rs(row,col,\"name\"))  \n..s mcontent=$g(rs(row,col,\"content\"))  \n..s mtype=$g(rs(row,col,\"type\"))  \n..w \"<div class='customItem' title='\"_mname_\"'><label>\"_mname_\"</label>\"  \n..i mtype'=\"M\" d  \n...w \"<div ondblclick='openPatientEditPanel(\"\"\"_ShiftType_\"\"\",\"\"\"_mid_\"\"\")'>\"_mcontent_\"</div></div>\"  \n..e  w \"<div class='editArea'><textarea id=\"\"wardsummary\"\" data-item=\"\"\"_mid_\"\"\" style='width:100%;resize: none;'>\"_mcontent_\"</textarea></div></div>\"  \n.w \"</div>\"  \n</SCRIPT>  \n</div>  \n<div id=\"bottom\">  \n<div id=\"bleft\">  \n<div class=\"tab\" style=\"border-bottom:1px solid #ccc;\">#(..Get(\"交班项目\"))#</div>  \n<div class=\"itemArea\">  \n<SCRIPT language=\"cache\" RUNAT=\"SERVER\">  \ns qb= ##class(websys.Translation).Get(\"nur.shift.index.showAll.csp\",\"全部\")  \n     d ##class(Nur.SHIFT.Service.Custom).GetRowInfo(WardID,TJDate,ShiftType,.shiftArr)  \n     if ItemDR=\"\" w \"<div id=\"\"item0\"\" class=\"\"tab selectedItem\"\" onclick='switchItem(this);reloadDetail(\"\"\"\",\"\"\"\",1)'>\"_qb_\"</div>\"  \n     e  w \"<div id=\"\"item0\"\" class=\"\"tab\"\" onclick='reloadDetail(\"\"\"\",\"\"\"\",1)'>\"_qb_\"</div>\"  \n     s items=##class(Nur.SHIFT.Service.ShiftBizV2).GetShiftItem(WardID)  \n     for i=1:1:items.Count()  \n     {  \n     s item=items.GetAt(i)  \n     s itemName=$p(item,\"^\",1)  \n     s itemDR=$p(item,\"^\",$l(item,\"^\"))  \n     s detailFlag=$p(item,\"^\",16)  \n     continue:detailFlag=\"N\"  \n     i detailFlag'=\"N\" s cname=\"tab\"  \n     e  s cname=\"tab\"  \n     s:itemDR=##class(Nur.SHIFT.Service.ShiftBizV2).#TOISBARITEM cname=\"tab\"  \n     s itemName= ##class(websys.Translation).Get(\"nur.shift.index.showAll.csp\",itemName)  \n     i itemDR=ItemDR {  \n     w \"<div title=\"\"\"_itemName_\"\"\" class=\"\"\"_cname_\" selectedItem\"\" onclick='switchItem(this);reloadDetail(\"\"\"\",\"\"\"_itemDR_\"\"\",1)'>\"_itemName_\"</div>\"  \n     }else{  \n     w \"<div title=\"\"\"_itemName_\"\"\" class=\"\"\"_cname_\"\"\" onclick='switchItem(this);reloadDetail(\"\"\"\",\"\"\"_itemDR_\"\"\",1)'>\"_itemName  \n     i $D(shiftArr(itemDR)) w \"<sup class=badge></sup>\"  \n     w \"</div>\"  \n     }  \n     }  \n     #;i ItemDR=##class(Nur.SHIFT.Service.ShiftBizV2).#TOISBARITEM w \"<div id=\"\"item2020\"\" class=\"\"tab selectedItem\"\" onclick='switchItem(this);reloadDetail(\"\"\"\",\"\"\"_##class(Nur.SHIFT.Service.ShiftBizV2).#TOISBARITEM_\"\"\",1)'>\"_\"提示性交班\"_\"</div>\"  \n     #;e w \"<div id=\"\"item2020\"\" class=\"\"tab last-tab\"\" onclick='switchItem(this);reloadDetail(\"\"\"\",\"\"\"_##class(Nur.SHIFT.Service.ShiftBizV2).#TOISBARITEM_\"\"\",1)'>\"_\"提示性交班\"_\"</div>\"  \n     </SCRIPT>  \n     </div>  \n</div>  \n     <div id=\"bright\">  \n     <table id=\"dg1\" data-options=\"view:scrollview,fitColumns:true,singleSelect:true,autoRowHeight:true,pagination:false,pageSize:1000,onDblClickCell:onDBClickCell,onClickCell:onClickCell,onAfterEdit:afterEdit\">  \n     <tr><th data-options=\"field:'patInfo',width:100;\">患者信息</th>  \n<th data-options=\"field:'reason',width:150\">项目</th>  \n<th data-options=\"field:'content',width:500\">交班内容</th></tr>  \n     </table>  \n     </div>  \n    </div>  \n    </div>  \n    <!--<div class=\"opacity\" style=\"display:flex;height:30px;justify-content:flex-end;align-items:center;\">  \n<div style=\"width:300px;\">  \n<span style=\"color:#8D8D8D;\">交班护士：</span><span id=\"sign\" style=\"text-decoration:underline\"></span>  \n</div>  \n<div style=\"width:300px;\">  \n<span style=\"color:#8D8D8D;\">接班护士：</span><span id=\"sign2\" style=\"text-decoration:underline\"></span>  \n</div>  \n<div style=\"width:300px;float:left;display:none\">  \n<span style=\"color:#8D8D8D;\">护士长签名：</span><span id=\"signM\" style=\"text-decoration:underline\"></span>  \n</div>  \n</div>-->  \n    </div>  \n  <div id=\"modalRebuild\" class=\"hisui-dialog\" title=\"重置班次\" style=\"width:500px;height:300px;top:230px;padding:10px;\" data-options=\"iconCls:'icon-w-reset',resizable:false,modal:true,closed:true,buttons:[{  \ntext:'重置',  \nhandler:resetShift  \n}]\">  \n<div id=\"shiftSelect\">  \n<SCRIPT language=\"cache\" RUNAT=\"SERVER\">  \ns allShifts=##class(Nur.SHIFT.Service.ShiftBizV2).GetAllTimeSetting(WardID)  \nfor i=1:1:allShifts.Count()  \n{  \ns shiftConf=allShifts.GetAt(i)  \ns shiftDR=shiftConf.GetAt(\"key\")  \ns shiftName=shiftConf.GetAt(\"value\")  \nw \"<div class=\"\"radioGroup\"\" style=\"\"padding-bottom:10px;\"\"><input class=\"\"hisui-radio\"\" type=\"\"radio\"\" name=\"\"radioshift\"\" value=\"\"\"_shiftDR_\"\"\"><p onclick=\"\"$(this).prev().click()\"\">\"_shiftName_\"</p></div>\"  \n}  \n</SCRIPT>  \n</div>  \n</div>  \n<div id=\"modalEditor\" class=\"hisui-dialog\" title=\"修改交班项目\" style=\"width:500px;top:230px;left:500px;padding:10px;\" data-options=\"iconCls:'icon-w-edit',resizable:false,modal:true,closed:true\">  \n<div id=\"modalEditorInner\">  \n<SCRIPT language=\"cache\" RUNAT=\"SERVER\">  \nfor i=1:1:items.Count()  \n     {  \n     s item=items.GetAt(i)  \n     s itemName=$p(item,\"^\",1)  \n     s itemDR=$p(item,\"^\",$l(item,\"^\"))  \n     w \"<input class=\"\"hisui-checkbox\"\" name=\"\"cbItem\"\" style=\"\"width:136px;\"\" type=\"\"checkbox\"\" value=\"\"\"_itemDR_\"\"\" label=\"\"\"_itemName_\"\"\" id=\"\"cb\"_itemDR_\"\"\">\"  \n     }  \n    </SCRIPT>  \n    <div style=\"margin:0 auto;text-align:center;margin-top:10px;\">  \n     <a href=\"#\" class=\"hisui-linkbutton\" onclick=\"modifyItem()\">确定</a><a href=\"#\" class=\"hisui-linkbutton\" onclick=\"closeItemEditor()\" style=\"margin-left:10px\">关闭</a>  \n    </div>  \n</div>  \n</div>  \n<div id=\"rightClickMenu\" class=\"easyui-menu\" style=\"width: 80px; display: none;\">  \n        <div id=\"btn_intro\" data-options=\"iconCls:'icon-ok'\" onClick=\"referHandler()\">引用</div>  \n        <div id=\"btn_copy\" data-options=\"iconCls:'icon-copy'\" onClick=\"copyHandler()\">复制</div>  \n        <div id=\"btn_paste\" data-options=\"iconCls:'icon-paste'\" onClick=\"pasteHandler()\">粘贴</div>  \n          \n</div>  \n<div id=\"dialogRefer\" class=\"hisui-dialog panel-body panel-body-noborder window-body\" data-options=\"closed:true,buttons:[{  \ntext:'关闭',  \niconCls:'icon-w-close',  \nid: 'btnClose',  \nhandler:closeHandler  \n},{  \ntext:'清屏',  \niconCls:'icon-w-clean',  \nid: 'btnClear',  \nhandler:clearHandler  \n},{  \ntext:'引用',  \niconCls:'icon-w-edit',  \nid: 'btnRefer',  \nhandler:sureReferHandler  \n}]\" style=\"overflow: hidden; width: 1958px; height: 1153px;\" title=\"\"></div>  \n<div id=\"confirmWin\" style=\"padding:10px\">  \n<div><a href=\"\" class=\"messager-icon messager-question\"></a>#(..Get(\"确认要变更此记录状态么？\"))#</div>  \n</div>  \n<div id=\"modalSign\" class=\"hisui-dialog\" title=\"交接班\" style=\"width:300px;top:230px;padding:10px 10px 0;\" data-options=\"iconCls:'icon-w-switch',resizable:false,modal:true,closed:true,buttons:[{  \ntext:'保存',  \nhandler:function(){MagicSave()}  \n}]\">  \n    <div style=\"margin:0 auto\">  \n     <label style=\"padding-right:10px;\">#(..Get(\"交班护士：\"))#</label><select id=\"nurseBox\" style=\"width:210px;\"></select>  \n    </div>  \n    <div  style=\"margin:10px auto\">  \n     <label style=\"padding-right:10px;\">#(..Get(\"接班护士：\"))#</label><select id=\"nurseBox2\" style=\"width:210px;\"></select>  \n    </div>  \n</div>  \n<div id=\"modalAddPatient\" class=\"hisui-dialog\" title=\"新增\" style=\"width:400px;top:230px;padding:10px;\" data-options=\"iconCls:'icon-w-add',resizable:false,modal:true,closed:true,onClose:closeAddPanel\">  \n    <input id=\"regNo\" class=\"textbox\" placeholder=#(..Get(\"回车检索登记号\"))# onkeydown=\"keyup_submit(event);\" style=\"margin-bottom:10px;width:180px;\"/>  \n    <table id=\"addPatTable\" style=\"margin:auto;height:72px;\"></table>  \n    <div style=\"text-align:center;margin-top:10px;\">  \n     <a href=\"#\" class=\"hisui-linkbutton\" onclick=\"addPatient()\">添加</a>  \n    </div>  \n</div>  \n<div id=\"modalEditPatient\" class=\"hisui-dialog\" title=\"编辑\" style=\"width:692px;top:100px;padding:10px;\" data-options=\"iconCls:'icon-w-edit',resizable:false,modal:true,closed:true,onClose:closePatientEditPanel\">  \n<div id=\"modalEditPatientInner\">  \n</div>  \n<div style=\"text-align:center;\">  \n<a href=\"#\" class=\"hisui-linkbutton\" onclick=\"modifyPatient()\">确定</a>  \n</div>  \n</div>  \n<div id=\"modalEditPC\" class=\"hisui-dialog\" title=\"编辑\" style=\"width:300px;height:130px;top:230px;padding:10px;\" data-options=\"iconCls:'icon-w-edit',resizable:false,modal:true,closed:true\">  \n<div id=\"modalEditPCInner\" style=\"width:200px;margin:0 auto\">  \n<label id=\"mlabel\" for=\"mpcount\"></label><input class=\"textbox\" id=\"mpcount\" name=\"mpcount\"/>  \n</div>  \n<div style=\"text-align:center;margin-top:10px;\">  \n<a href=\"#\" class=\"hisui-linkbutton\" onclick=\"modifyPatientCount()\">确定</a>  \n</div>  \n</div>  \n<div id=\"modalModifyLog\" class=\"hisui-dialog\" title=\"修改记录\" style=\"width:1200px;height:600px;padding:10px;overflow:hidden;\" data-options=\"iconCls:'icon-w-paper',resizable:false,modal:true,closed:true\">  \n<table cellpadding=\"0\" cellspacing=\"0\" style=\"padding-bottom:10px;\">  \n<tr>  \n<td class=\"r-label\">#(..Get(\"开始日期\"))#</td>  \n<td class=\"r-label\"><input class=\"hisui-datebox\" id=\"startDate\" style=\"width:120px;\"/></td>  \n<td class=\"r-label\">#(..Get(\"结束日期\"))#</td>  \n<td class=\"r-label\"><input class=\"hisui-datebox\" id=\"endDate\" style=\"width:120px;\" /></td>  \n<td class=\"r-label\">#(..Get(\"班次\"))#</td>  \n<td class=\"r-label\"><select id=\"shift\" style=\"width:120px;\"></select></td>  \n<td class=\"r-label operateType\">#(..Get(\"操作类型\"))#</td>  \n<td class=\"r-label operateType\"><select id=\"operateType\" style=\"width:80px;\"></select></td>  \n<td>  \n<a id=\"search\" href=\"javascript:void(0);\" class=\"hisui-linkbutton\" data-options=\"iconCls:'icon-w-find'\" onclick=\"searchModifyLog()\">查询</a>  \n</td>  \n</tr>  \n</table>  \n<div id=\"logList\">  \n<div id=\"tabs\" class=\"hisui-tabs tabs-gray\" data-options=\"fit:true\">  \n<div title=\"统计区/中间区\">  \n<table id=\"dgLog0\"></table>  \n</div>  \n<div title=\"明细区\">  \n<table id=\"dgLog1\"></table>  \n</div>  \n</div>  \n</div>  \n</div>  \n</body>  \n<script language=\"javascript\">  \n$.fn.watch = function (callback) {  \n        return this.each(function () {  \n            //缓存以前的值  \n            $.data(this, 'originVal', $(this).val());  \n            $(this).on('keyup paste input propertychange', function () {  \n                var originVal = $.data(this, 'originVal');  \n                var currentVal = $(this).val();  \n                if (originVal !== currentVal) {  \n                    $.data(this, 'originVal', $(this).val());  \n                    callback(currentVal,originVal,$(this));  \n                }  \n            });  \n        });  \n    }  \n      \n    $(\"textarea\").watch(function(value,oldval,ele) {  \nconsole.log(value)  \n    });  \n   \n  \n  \n</script>  \n<script language=\"javascript\">  \n  \nwindow.WebIp = window.location.href.split(\"/csp/\")[0];  \nvar setDataGrid,rowData;  \nvar unfoldFlag=\"false\";  \nfunction keyup_submit(e){  \nvar evt = window.event || e;  \n  if (evt.keyCode == 13){  \n  var regNo=$(\"#regNo\").val()  \n  if (parseFloat(regNo).toString() == \"NaN\")  \n  {  \n $(\"#regNo\").val(\"\")  \n $(\"#addName\").val(\"\")  \n return;  \n}  \n  regNo=(Array(10).join(\"0\") + regNo).slice(-10);  \n  $(\"#regNo\").val(regNo)  \n  $HUI.datagrid('#addPatTable',{  \n  singleSelect:true,  \n  fitColumns:true,  \n     columns:[[  \n{field:'episodeID',title:'就诊号',width:100},  \n{field:'cname',title:'姓名',width:100},  \n{field:'inHostDate',title:'入院日期',width:154},  \n]],  \n     url:$URL+\"?ClassName=Nur.SHIFT.Service.ShiftBizV2&QueryName=QueryEpisodeInfo&RegNo=\"+regNo,  \n     });  \n  }  \n}  \nfunction addPatient()  \n{  \nvar regNo = $.trim($(\"#regNo\").val());  \nif(!regNo){  \n$.messager.popover({ msg: '请输入登记号回车', type: 'alert' });  \n}  \nvar row = $('#addPatTable').datagrid('getSelected')  \nif(row&&row.episodeID)  \n{  \n$cm({  \n            ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n            MethodName: \"AddPatientRecord\",  \n            WardID: wardID,  \n            TJDate: tjDate,  \n            ShiftType: shiftType,  \n            EpisodeID:row.episodeID  \n        },  \n        function (data) {  \n            $.messager.popover({ msg: '增加成功', type: 'success', timeout: 1000 });  \n            // 添加修改记录日志  \nsaveModifyLog(shiftType,\"\",row.episodeID,\"\",\"\",\"\",\"\",\"\",\"\",\"D\",\"A\")  \n            reloadDetail(\"\",\"\",1);  \n            //location.reload();  \n        });  \n        $HUI.dialog('#modalAddPatient').close();  \n}else  \n{  \n$.messager.popover({ msg: '请选择一条记录', type: 'alert', timeout: 1000 });  \n}  \n}  \n  \n/**  \n    * @description 展示病人标题信息  \n    * @param {EpisodeID} 患者就诊号  \n    */  \n  \nfunction resetShift() {  \nvar check = $HUI.radio(\":checked\");  \n    if (!check.jdata) {  \n        $.messager.popover({ msg: '请选择班别', type: 'alert' });  \n    } else {  \n        $cm({  \n            ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n            MethodName: \"RebuildClsRecord\",  \n            WardID: wardID,  \n            IDate: tjDate,  \n            ShiftSettingDR: checkedShiftDR  \n        },  \n        function (data) {  \n            $HUI.dialog(\"#modalRebuild\").close()  \n            $.messager.popover({ msg: '重置成功', type: 'success', timeout: 1000 });  \n            setTimeout(function(){  \n                self.location.href = \"nur.shift.index.showAll.csp?WardID=\" + wardID + \"&TJDate=\" + tjDate  \n            },1000);  \n        })  \n    }  \n};  \nvar editIndex = -1;  \nvar editField = \"\";  \nvar curElement = null;  \n /**  \n     * @description: 获取高亮选中的内容  \n     * @param {curElement}  \n     * @return:  \n     */  \n    function getSelectionText(curElement) {  \n        if (!curElement) {  \n            return false;  \n        }  \n        var selectedText = '';  \n        if (typeof document.selection != 'undefined') {  \n             selectedText = document.selection.createRange().text;  \n        } else {  \n             selectedText = curElement.value.substr(curElement.selectionStart, curElement.selectionEnd - curElement.selectionStart);  \n        }  \n        return selectedText.trim();  \n    }  \n$.extend($.fn.datagrid.defaults.editors, {  \n    text: {  \n        init: function (container, options) {  \n            var input = $('<textarea style=\"height:100px\">').appendTo(container);  \n            curElement = input[0];  \n            input.bind('contextmenu', function (e) {  \n                e.preventDefault();  \n                $('#rightClickMenu').menu('show', {  \n                    left: e.pageX,  \n                    top: e.pageY  \n                });  \n            });  \n            input.mouseup(function (e) {  \n             curElement = e.target;  \n             window.clipboardContent = getSelectionText(e.target);  \n             console.log(window.clipboardContent);  \n         });  \n            return input;  \n        },  \n        getValue: function (target) {  \n            return $(target).val();  \n        },  \n        setValue: function (target, value) {  \n            $(target).val(value);  \n        },  \n        resize: function (target, width) {  \n            var input = $(target);  \n            if ($.boxModel == true) {  \n                input.width(width - (input.outerWidth() - input.width()));  \n            } else {  \n                input.width(width);  \n            }  \n        }  \n    }  \n});  \n  \n$.extend($.fn.datagrid.methods, {  \n    editCell: function (jq, param) {  \n        return jq.each(function () {  \n            var opts = $(this).datagrid('options');  \n            var fields = $(this).datagrid('getColumnFields', true).concat(  \n                $(this).datagrid('getColumnFields'));  \n            for (var i = 0; i < fields.length; i++) {  \n                var col = $(this).datagrid('getColumnOption', fields[i]);  \n                col.editor1 = col.editor;  \n                if (fields[i] != param.field) {  \n                    col.editor = null;  \n                }  \n            }  \n            $(this).datagrid('beginEdit', param.index);  \n            for (var i = 0; i < fields.length; i++) {  \n                var col = $(this).datagrid('getColumnOption', fields[i]);  \n                col.editor = col.editor1;  \n            }  \n        });  \n    }  \n});  \n// 双击若无编辑内容开启编辑  \nfunction onDBClickCell(index, field,value) {  \nvar selected = $(\"#dg1\").datagrid(\"getSelected\");  \nif(selected && selected.Status == \"D\"){  \n$.messager.popover({ msg: '已删除记录不能编辑', type: 'alert' });  \n        return;  \n}  \nconsole.log(\"dbClick\");  \n    if (editIndex < 0) {  \n        $('#dg1').datagrid('selectRow', index).datagrid('editCell', {  \n            index: index,  \n            field: field  \n        });  \n        editIndex = index;  \n        editField=field;  \n    }  \n}  \n// 单击 若有在编辑列关闭编辑  \nfunction onClickCell(index, field,value) {  \n    if ((editIndex >= 0)&& ((editIndex != index)||(field!=editField))) {  \n        $('#dg1').datagrid('endEdit', editIndex);  \n        editIndex = -1;  \neditField=\"\";  \n        curElement = null;  \n    }  \n    onDBClickCell(index, field,value);  \n}  \n// 保存交班内容  \nfunction saveShiftContent(){  \nif(editIndex>=0 && editField!=\"\"){  \n$('#dg1').datagrid('endEdit', editIndex);  \n        editIndex = -1;  \neditField=\"\";  \n        curElement = null;  \n}  \n}  \nfunction afterEdit2(index, row, changes){  \ndebugger  \n    var _episodeID=row.episodeID  \n    var _mainRecordDR=row.mainRecordDR  \n    var _clsSub=row.clsSub  \n    var _patSub=row.patSub  \n    var _key=\"\"  \n    for(var key in changes)  \n    {  \n_key=key  \n}  \nvar _keyJson = {\"A\":\"1\",\"P\":\"2\",\"N\":3}  \nif (_key!=\"\"){  \nvar _clsSub = _keyJson[_key]  \n}  \n    if(_key!=\"\")  \n    {  \nvar _value=changes[_key]  \n$cm({  \nClassName:\"Nur.Custom.NeedUnit.NeedUnit231010\",  \nMethodName:\"SaveContent\",  \nShiftRecordId:_mainRecordDR+\"||\"+_clsSub+\"||\"+_patSub,  \nValue:_value  \n},function(data){  \nif((data==0)||(data==\"0\"))  \n{  \n// 添加修改记录日志  \nsaveModifyLog(shiftType,row.bedNo,row.episodeID,row.itemDRStr,row.itemDRStr,\"\",\"\",allContent[index],_value,\"D\",\"M\")  \nallContent[index]=_value;  \n$.messager.popover({msg: '保存成功！',type:'success',timeout: 1000});  \n}else  \n{  \n$.messager.popover({msg: data,type:'alert',timeout: 1000});  \n}  \n$(\"#dg1\").datagrid(\"reload\");  \n$(\"td\").removeClass(\"datagrid-value-changed\");  \n});  \n}  \n}  \nfunction afterEdit(index, row, changes) {  \nreturn afterEdit2(index, row, changes)  \n    var _episodeID=row.episodeID  \n    var _mainRecordDR=row.mainRecordDR  \n    var _clsSub=row.clsSub  \n    var _patSub=row.patSub  \n    var _key=\"\"  \n    for(var key in changes)  \n    {  \n_key=key  \n}  \n  \n    if(_key!=\"\")  \n    {  \nvar _value=changes[_key]  \n$cm({  \nClassName:\"Nur.SHIFT.Service.ShiftBizV2\",  \nMethodName:\"SavePatEdit\",  \nMainRecordDR:_mainRecordDR,  \nClsSub:_clsSub,  \nPatSub:_patSub,  \nKey:_key,  \nValue:_value  \n},function(data){  \nif((data==0)||(data==\"0\"))  \n{  \n// 添加修改记录日志  \nsaveModifyLog(shiftType,row.bedNo,row.episodeID,row.itemDRStr,row.itemDRStr,\"\",\"\",allContent[index],_value,\"D\",\"M\")  \nallContent[index]=_value;  \n$.messager.popover({msg: '保存成功！',type:'success',timeout: 1000});  \n}else  \n{  \n$.messager.popover({msg: data,type:'alert',timeout: 1000});  \n}  \n$(\"#dg1\").datagrid(\"reload\");  \n$(\"td\").removeClass(\"datagrid-value-changed\");  \n});  \n}  \n}  \nfunction referHandler() {  \n    if (editIndex < 0) {  \n        return;  \n    }  \n    var row = $('#dg1').datagrid('getRows')[editIndex];  \n    console.log(row);  \n    var episodeID = row.episodeID;  \n    var url = \"nur.hisui.shiftLog.csp?EpisodeID=\" + episodeID + \"&Tabs=Know,Diag,Order,Exec,Obs,Lis,Pacs,Epr,Chars,Record1\";  \n    $('#dialogRefer').dialog({  \n        title: '引用',  \n        width: $(window).width() - 100,  \n        height: 600,  \n        top:100,  \n        cache: false,  \n        content: \"<iframe id='iframeRefer' scrolling='auto' frameborder='0' src='\" + url + \"' style='width:100%; height:100%; display:block;'></iframe>\",  \n        modal: true  \n    });  \n    $(\"#dialogRefer\").dialog(\"open\");  \n  \n}  \nfunction getCursortPosition(obj) {  \n    var cursorIndex = 0;  \n    if (document.selection) {  \n        // IE Support  \n        obj.focus();  \n        var range = document.selection.createRange();  \n        range.moveStart('character', -obj.value.length);  \n        cursorIndex = range.text.length;  \n    } else if (obj.selectionStart || obj.selectionStart == 0) {  \n        // another support  \n        cursorIndex = obj.selectionStart;  \n    }  \n    return cursorIndex;  \n}  \nfunction updateRefer(curElement, editContent, curPosition) {  \n    var startText = curPosition == 0 ? '' : curElement.value.substring(0, curPosition);  \n    if (startText.trim() == '/') {  \n        startText = '';  \n    }  \n    var endText = curElement.value.substring(curPosition);  \n    curElement.value = startText + editContent + endText;  \n}  \nfunction sureReferHandler() {  \n    var textEdit = $('#iframeRefer').contents().find('#textEdit')[0];  \n    var editContent = $(textEdit).val();  \n    if (!editContent) {  \n        //alert('没有要引用的内容!');  \n        $.messager.alert('提示', '没有要引用的内容!');  \n        return;  \n    }  \n    if (!curElement) {  \n        // $.messager.popover({ msg: '请选择需要引用的元素！', type:'error'});  \n        //return;  \n    }  \n    var curPosition = getCursortPosition(curElement);  \n    updateRefer(curElement, editContent, curPosition);  \n    closeHandler();  \n}  \n /**  \n     * @description: 复制  \n     */  \n    function copyHandler(e) {  \n    if (typeof window.clipboardData == 'undefined') {  \n//非IE  \n$('#rightClickMenu').attr('data-clipboard-text', clipboardContent);  \n//var clipboard = new Clipboard('#menuCopy');  \n}else{  \n//IE  \nwindow.clipboardData.setData('Text', clipboardContent);  \n}  \n    }  \n    /**  \n     * @description: 粘贴  \n     */  \n    function pasteHandler(e) {  \n    var clipContent = '';  \n    if (typeof window.clipboardData == 'undefined') {  \n//非IE  \nclipContent = $('#rightClickMenu').attr('data-clipboard-text');  \n}else{  \n//IE  \nclipContent = window.clipboardData.getData('Text');  \n}  \n        if (!!clipContent) {  \n            updateRefer(curElement, clipContent, getCursortPosition(curElement));  \n        }  \n    }  \nfunction clearHandler() {  \n    var textEdit = $('#iframeRefer').contents().find('#textEdit')[0];  \n    $(textEdit).val('');  \n}  \nfunction closeHandler() {  \n    $('#dialogRefer').dialog('close');  \n}  \nfunction closeItemEditor()  \n{  \n$(\"#modalEditor\").window('close');  \n}  \nvar modifiedItemDR=\"\"  \nvar modifiedDate=\"\"  \nvar modifiedShiftType=\"\"  \nvar originChecked=[],originPat=[];  \nfunction modifyPatient()  \n{  \nif((modifiedItemDR==\"\")||(modifiedDate==\"\")||(modifiedShiftType==\"\")) return;  \nvar boxes=$(\"[name='cbp']\")  \nvar addPatient=[]  \nvar deletePatient=[]  \nvar nowChecked=[],nowPat=[];  \n for(var i=0;i<boxes.length;i++)  \n {  \n var box=boxes[i]  \n var value=parseInt(box.value);  \n var text=box.getAttribute(\"label\");  \nif(box.checked)  \n{  \nnowChecked.push(value);  \nnowPat.push(text)  \nif(originChecked.indexOf(value)==-1)  \n{  \naddPatient.push(value)  \n}  \n}else  \n{  \nif(originChecked.indexOf(value)>-1)  \n{  \ndeletePatient.push(value)  \n}  \n  \n}  \n }  \n if(nowPat.length>0){  \nnowPat.sort(function(a,b){  \nreturn a.split(\" \")[0]-b.split(\" \")[0];  \n})  \n }  \n if((addPatient.length==0)&&(deletePatient.length==0)) return  \n $cm(  \n        {  \n         ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n            MethodName: \"ModifyValidPatients\",  \n            WardID: wardID,  \n            TJDate: modifiedDate,  \n            ShiftType: modifiedShiftType,  \n            ItemDR: modifiedItemDR,  \n            AddPatients: addPatient.join(\"^\"),  \n            DelPatients: deletePatient.join(\"^\")  \n        },  \n        function (data) {  \n        // 添加修改日志  \nsaveModifyLog(modifiedShiftType,\"\",\"\",modifiedItemDR,\"\",originChecked.length,nowChecked.length,originPat.join(\"^\"),nowPat.join(\"^\"),\"C\",\"M\");  \n        $(\"#modalEditPatient\").window('close');  \n            location.reload();  \n            //reloadDetail(\"\",\"\",1);  \n        })  \n}  \nfunction modifyPatientCount()  \n{  \nif((modifiedItemDR==\"\")||(modifiedDate==\"\")||(modifiedShiftType==\"\")) return;  \nvar value=$(\"#mpcount\").val();  \nif(value==\"\") return;  \n $cm(  \n        {  \n         ClassName: \"Nur.SHIFT.Service.ShiftBiz\",  \n            MethodName: \"SaveClsItemCount\",  \n            WardID: wardID,  \n            TjDate: modifiedDate,  \n            ClsType: modifiedShiftType,  \n            ItemDR: modifiedItemDR,  \n            Count: value  \n        },  \n        function (data) {  \n       $(\"#modalEditPC\").window('close');  \n           location.reload();  \n           //reloadDetail(\"\",\"\",1);  \n        })  \n}  \nfunction modifyItem()  \n{  \n var selected = $(\"#dg1\").datagrid(\"getSelected\");  \n var _itemDRS=[]  \n var boxes=$(\"[name='cbItem']\")  \n for(var i=0;i<boxes.length;i++)  \n {  \nif(boxes[i].checked==true)  \n{  \n_itemDRS.push(boxes[i].value)  \n}  \n }  \n $cm(  \n        {  \n         ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n            MethodName: \"SaveItemBatch\",  \n            MainRecordDR: selected[\"mainRecordDR\"],  \n            ClsSub: selected[\"clsSub\"],  \n            PatSub: selected[\"patSub\"],  \n            ItemDRS:_itemDRS.join(\"^\")  \n        },  \n        function (data) {  \n        // 添加修改记录日志  \nsaveModifyLog(shiftType,selected[\"bedNo\"],selected[\"episodeID\"],selected[\"itemDRStr\"],_itemDRS.join(\"^\"),\"\",\"\",selected[\"content\"],selected[\"content\"],\"D\",\"M\");  \n        $(\"#modalEditor\").window('close');  \n            $.messager.popover({ msg: '修改成功', type: 'success', timeout: 1000 });  \n            location.reload();  \n            //reloadDetail(\"\",\"\",1);  \n        })  \n}  \nfunction MagicSave()  \n{  \nvar sign = $HUI.combobox(\"#nurseBox\").getValues().join(\"@\")  \nvar signA = $HUI.combobox(\"#nurseBox2\").getValues().join(\"@\")  \nif(!sign || !signA){  \n$.messager.popover({ msg: $g('请选择交接班护士'), type: 'success', timeout: 1000 });  \nreturn;  \n}  \n$cm({  \n     ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n        MethodName: \"ShiftMagicSave\",  \n        WardID:wardID,  \n        TJDate:tjDate,  \n        ShiftType:shiftType,  \n        Sign:$HUI.combobox(\"#nurseBox\").getValues().join(\"@\"),  \n        SignA:$HUI.combobox(\"#nurseBox2\").getValues().join(\"@\")  \n    },function (data) {  \n       $.messager.popover({ msg: '签名成功', type: 'success', timeout: 1000 });  \n       $HUI.dialog(\"#modalSign\").close()  \n       patientStatistics();  \n    })  \n}  \nfunction PrintNormal()  \n{  \n$cm(  \n        {  \n         ClassName: \"Nur.SHIFT.Service.Emr.EmrService\",  \n            MethodName: \"GetPrintParamV2\",  \n            WardID:wardID,  \n            TJDate:tjDate  \n        },  \n        function (data) {  \n        // 外部数据源打印bug fix  \n           var serverURL = window.location.href.split(\"/csp/\")[0]; // + \"/\";  \n           var emrPrintCode = data.emrPrintCode;  \n           var params = [  \n           locID,  \n           wardID,  \n           tjDate,  \n           \"@@\",  \n           \"@@\",  \n           \"Y\",  \n           \"\",  \n           shiftType  \n         ];  \n         AINursePrintAll(  \n           serverURL,  \n           emrPrintCode,  \n           1,  \n          params.join(\"^\"),  \n          ifSignCA  \n         );  \n        })  \n}  \nfunction AbolishSign()  \n{  \n$cm(  \n        {  \n         ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n            MethodName: \"AbolishSign\",  \n            WardID:wardID,  \n            TJDate:tjDate,  \n            ShiftType:shiftType  \n        },  \n        function (data) {  \n           $.messager.popover({ msg: '撤销成功', type: 'success', timeout: 1000 });  \n           patientStatistics();  \n        })  \n}  \nfunction openModal(modalID)  \n{  \n$(\"#\"+modalID).window('open');  \n}  \nfunction saveSummary(CurWardsummary,ItemDR)  \n{  \nvar summary=$.trim($(\"#wardsummary\").val());  \nif(summary==CurWardsummary) return;  \n$cm(  \n        {  \n         ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n            MethodName: \"SaveWardDesc\",  \n            WardID:wardID,  \n            TJDate:tjDate,  \n            ShiftType:shiftType,  \n            WardSummary:summary  \n        },  \n        function (data) {  \n            $.messager.popover({ msg: '保存病区概况成功', type: 'success', timeout: 1000 });  \n            // 保存修改日志  \nsaveModifyLog(shiftType,\"\",\"\",ItemDR,\"\",\"\",\"\",CurWardsummary,summary,\"M\",\"M\");  \n        })  \n}  \n// 切换交班项目  \nfunction switchItem(elem){  \n$(elem).addClass(\"selectedItem\").siblings().removeClass(\"selectedItem\");  \n  \n}  \n  \nvar allContent=[];  \nfunction loadDetailData2()  \n{  \n$.cm({  \nClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n        QueryName: \"QueryShiftDetailList\",  \n        WardID: wardID,  \n        QDate: tjDate,  \n        ShiftType: shiftType,  \n        ItemDR: itemSelect,  \n        ShowAll:showAll,  \nrows:99999,  \nloadMsg:\"加载中...\",  \n},function(data){  \nallContent=[];  \nvar record=data.rows;  \nif(record.length>0){  \nrecord.forEach(function(val){  \nallContent.push(val.content);  \n})  \n}  \nsetDataGrid.datagrid('loadData',data);  \nsetTimeout(function(){  \n$(\"#bright\").css({opacity: \"1\"})  \n$('body').addClass('active')  \n},500)  \n})  \n}  \nfunction loadDetailData()  \n{  \nreturn loadDetailData2()  \n$.cm({  \nClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n        QueryName: \"QueryShiftDetailList\",  \n        WardID: wardID,  \n        QDate: tjDate,  \n        ShiftType: shiftType,  \n        ItemDR: itemSelect,  \n        ShowAll:showAll,  \nrows:99999,  \nloadMsg:\"加载中...\",  \n},function(data){  \nallContent=[];  \nvar record=data.rows;  \nif(record.length>0){  \nrecord.forEach(function(val){  \nallContent.push(val.content);  \n})  \n}  \nsetDataGrid.datagrid('loadData',data);  \nsetTimeout(function(){  \n$(\"#bright\").css({opacity: \"1\"})  \n$('body').addClass('active')  \n},500)  \n})  \n}  \n  \nfunction loadCumstomDetailData()  \n{  \n$.cm({  \nClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n        MethodName: \"CustomColumnDetail\",  \n        WardID: wardID,  \n        QDate: tjDate,  \n        ShiftType: shiftType,  \nrows:99999,  \nloadMsg:\"加载中...\",  \n},function(data){  \nconsole.log(data);  \nsetDataGrid.datagrid('loadData',data);  \n$(\"#bright\").css({opacity: \"1\"})  \n  \n})  \n}  \n  \n  \nfunction setPatRecordStatus (status){  \nvar msgtext = \"\"  \nmsgtext = status==\"D\"? \"删除成功\":msgtext;  \nmsgtext = status==\"H\"? \"隐藏成功\":msgtext;  \nmsgtext = status==\"N\"? \"恢复成功\":msgtext;  \n  \nvar selections = $(\"#dg1\").datagrid(\"getSelections\");  \nfor(var i=0;i<selections.length;i++){  \nvar selected = selections[i]  \n$cm(  \n{  \nClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \nMethodName: \"SetPatRecordStatus\",  \nMainRecordDR: selected[\"mainRecordDR\"],  \nClsSub: selected[\"clsSub\"],  \nPatSub: selected[\"patSub\"],  \nStatus:status  \n},  \nfunction (data) {  \n// 添加修改记录日志  \nsaveModifyLog(shiftType,selected[\"bedNo\"],selected[\"episodeID\"],selected[\"itemDRStr\"],selected[\"itemDRStr\"],\"\",\"\",selected[\"content\"],selected[\"content\"],\"D\",\"D\");  \n$.messager.popover({ msg: msgtext, type: 'success', timeout: 1000 });  \n$('#confirmWin').dialog(\"close\");  \n//reloadDetail(shiftType,itemSelect,1);  \nlocation.reload();  \n})  \n}  \n}  \n  \n  \n  \n// 初始化病人列表  \nfunction reloadDetail(_shiftType, _itemDR, isReload){  \ndebugger  \n$(\"#bright\").css({opacity: \"0\"})  \nif (_shiftType != \"\") {  \n        shiftType = _shiftType  \n    }  \n    var shiftName=$m({  \nClassName:\"Nur.SHIFT.Service.ShiftBizV2\",  \nMethodName:\"GetShiftName\",  \nShiftType:shiftType  \n},false);  \n    itemSelect = _itemDR  \n    if(isReload){  \n    $(\"#bright .datagrid\").remove();  \n    var height = $(\"#bottom\").height();  \n    var html = '<table id=\"dg1\" data-options=\"view:scrollview,fitColumns:true,singleSelect:true,autoRowHeight:true,pagination:false,pageSize:1000,onClickCell:onClickCell,onAfterEdit:afterEdit\" style=\"height:'+height+'px\">'  \n        +'</table>'  \n$(\"#bright\").append(html)  \n}  \n//if(isReload != 2){  \n  \n    \nif (itemSelect == 2020) {  \n$cm(  \n        {  \n         ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n            MethodName: \"GetColumnSetting\",  \n            WardID: wardID  \n        },  \n        function (jsonData) {  \n        var valueColumn=jsonData[jsonData.length-1]  \n        for(var i=0;i<valueColumn.length;i++)  \n        {  \n     var column=valueColumn[i];  \n     if(column.formatter)  \n     {  \n     var express=column.formatter;  \n     column.formatter=function(value,row,index)  \n     {  \n     return eval(express);  \n    }  \n    }  \n    }  \n       setDataGrid = $(\"#dg1\").datagrid({  \n    toolbar: [{  \n            iconCls: 'icon-add',  \n                text: '填入数据',  \n                handler: function () {  \n                var selected = $(\"#dg1\").datagrid(\"getSelected\");  \n                    if (selected == null) {  \n                        $.messager.popover({ msg: $g('请选择一条记录'), type: 'alert' });  \n                     return;  \n                    }  \n                    $cm({  \n                 ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n                MethodName: \"FillData\",  \n                 MainRecordDR: selected[\"mainRecordDR\"],  \n                 ClsSub: selected[\"clsSub\"],  \n                 PatSub: selected[\"patSub\"],  \n            },  \n             function (data) {  \n                 reloadDetail(shiftType,itemSelect,1);  \n            })  \n            }  \n         }],  \n            columns: jsonData  \n        })  \n        //loadDetailData()  \n     loadCumstomDetailData();  \n        })  \n    } else {  \nvar newColumns = [[{checkbox:true},  \n                {  \n                    field: 'patInfo', title: '患者信息', width: 120, align: 'left',  \n                    styler: function (value, row, index) {  \n                        return 'font-weight:bold;white-space: nowrap;';  \n                        // the function can return predefined css class and inline style  \n                        // return {class:'c1',style:'color:red'}  \n                    },  \n                    formatter: function(value,row,index){  \n                    if (row.Status==\"D\"){  \nreturn value + '<span class=\"shiftStatus icon-delete\"></span>'  \n}else if(row.Status==\"H\")  \n{  \nreturn value + '<span class=\"shiftStatus icon-hidden\"></span>'  \n}else{  \nreturn value  \n}  \n}  \n  \n                },  \n                {  \n                    field: 'reason', title: '项目', width: 150, align: 'left',  \n                    formatter: function(value,row,index){  \n                     return value ? '<span title=\"'+value+'\" style=\"display:inline-block;width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis\">'+value+'</span>' : ''      \n                }  \n                }/*,  \n                {  \n                    field: 'content', title: '交班内容'+shiftName, width: 1000, align: 'left', editor: {  \n                        type: 'text'  \n                    }  \n                }*/  \n            ]]  \n              \n  \n        var shiftConfig = tkMakeServerCall(\"Nur.Custom.NeedUnit.NeedUnit231010\",\"GetShiftConfig\",wardID,tjDate)  \n        var arrayJson = shiftConfig.split(\"^\")  \n        var contentJson = {\"0\":\"A\",\"1\":\"P\",\"2\":\"N\"}  \n        for (var i = 0; i < arrayJson.length; i++){  \nvar content = contentJson[i]  \n     var str = arrayJson[i]  \n     var shiftRecordId = str.split(\"#\")[0]  \n     var shiftName = str.split(\"#\")[1]  \n        var filedJson =                  \n         {  \n                    field: content, title: '交班内容'+shiftName, width: 500, align: 'left', editor: {  \n                        type: 'text'  \n                    }  \n         }  \n     newColumns[0].push(filedJson)  \n    }  \n        setDataGrid = $(\"#dg1\").datagrid({  \n            toolbar: [{  \n            iconCls: 'icon-add',  \n                text: '新增',  \n                handler: function () {  \n                //web.DHCExamPatList  \n                //PatListBroker  \n                $(\"#modalAddPatient\").window('open');  \n            }  \n             },{  \n                iconCls: 'icon-big-switch',  \n                text: '变更状态',  \n                handler: function () {  \n                var selected = $(\"#dg1\").datagrid(\"getSelected\");  \n                    if (selected == null) {  \n                        $.messager.popover({ msg: '请选择一条记录', type: 'alert' });  \n                     return;  \n                    }  \n                $('#confirmWin').dialog({  \n     width: 280,  \n     height: 160,  \n     title:\"变更状态\",  \n     iconCls:\"icon-w-switch\",  \n     closed: true,  \n     cache: false,  \n     modal: true,  \n     //content:\"确认要变更此记录状态么\",  \n     buttons:[  \n     {  \n     text:$g('删除'),  \n     handler:function(){  \n      \n     setPatRecordStatus(\"D\")  \n             \n     }  \n     },  \n     {  \n     text:'隐藏',  \n     handler:function(){  \n     setPatRecordStatus(\"H\")  \n     }  \n     },  \n     {  \n     text:'恢复',  \n     handler:function(){  \n     setPatRecordStatus(\"N\")  \n     }  \n     }  \n     ]  \n});  \n$('#confirmWin').dialog(\"open\");  \n              \n            }  \n            }, {  \n                iconCls: 'icon-write-order',  \n                text: '修改',  \n                handler: function () {  \n                    var selected = $(\"#dg1\").datagrid(\"getSelected\");  \n                    if (selected == null) {  \n                        $.messager.popover({ msg: $G('请选择一条记录'), type: 'alert' });  \n                    }if(selected.Status == \"D\"){  \n                    $.messager.popover({ msg: $G('已删除记录不能编辑'), type: 'alert' });  \n                     return;  \n                } else {  \n                   \n                    $cm(  \n             {  \n                 ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n                MethodName: \"GetValidItem\",  \n                 MainRecordDR: selected[\"mainRecordDR\"],  \n                 ClsSub: selected[\"clsSub\"],  \n                 PatSub: selected[\"patSub\"],  \n            },  \n             function (data) {  \n             for(var i=0;i<data.length;i++)  \n             {  \n             var cell=data[i]  \n             var id=\"cb\"+cell.value  \n             var checked=cell.checked  \n             var jqCheckBox=$(\"#\"+id)  \n             if(checked>0)  \n             {  \n             jqCheckBox.checkbox(\"check\");  \n             }else  \n             {  \n             jqCheckBox.checkbox(\"uncheck\");  \n             }  \n             }  \n                 $(\"#modalEditor\").window('open');  \n            })  \n                   \n                    }  \n                }  \n            },{  \n         iconCls: 'icon-all-select',  \n                text: showAll==\"\"?'显示全部记录':'显示有效记录',  \n                handler: function (){  \n             if(showAll==\"\")  \n             {  \n             showAll=\"Y\"  \n             $(this).find(\".l-btn-text\").text(\"显示有效记录\")  \n            }else  \n            {  \n           showAll=\"\"  \n           $(this).find(\".l-btn-text\").text(\"显示全部记录\")  \n        }  \n             reloadDetail(shiftType,itemSelect,1);  \n            }  \n        },  \n        ],  \n        singleSelect: false,  \n  \nselectOnCheck: true,  \n  \ncheckOnSelect: true,  \n            columns: newColumns,  \n            detailFormatter: function (rowIndex, rowData) {  \n                return (  \n                    \"<table><tr>\" +  \n                    '<td style=\"border:0;padding-right:10px;width:300px\">' +  \n                    '<p style=\"font-weight:bolder;font-size:20px\">' +  \n                    rowData.bedNo +  \n                    \" \" +  \n                    rowData.name +  \n                    \"</p>\" +  \n                    \"<p>\" +  \n                    rowData.regNo +  \n                    \"</p>\" +  \n                    \"<p>\" +  \n                    rowData.diagnois +  \n                    \"</p>\" +  \n                    \"</td>\" +  \n                    '<td style=\"border:0;padding-right:10px;width:1180px\">' +  \n                    \"<p style='color:blue'> \" +  \n                    rowData.A +  \n                    \"</p>\" +  \n                    \"<p style='color:red'> \" +  \n                    rowData.P +  \n                    \"</p>\" +  \n                    \"<p> \" +  \n                    rowData.N +  \n                    \"</p>\" +  \n                    \"</td>\" +  \n                    \"</tr></table>\"  \n                );  \n            }  \n        });  \n        loadDetailData();  \n    }  \n      \n}  \n  \n// 改变窗口大小，重新渲染页面  \nfunction resizeFresh(){  \nself.location.href = \"nur.shift.index.showAll.csp?WardID=\" + wardID + \"&TJDate=\" + tjDate + \"&ItemDR=\" + itemSelect + \"&ShiftType=\" + shiftType+\"&ShowAll=\"+showAll  \n}  \n  \n// 关闭新增弹窗时清除登记号  \nfunction closeAddPanel(){  \n$(\"#regNo\").val(\"\");  \n$(\"#modalAddPatient .datagrid\").remove();  \n$(\"#regNo\").after('<table id=\"addPatTable\" style=\"margin:auto;height:72px;\"></table>')  \n}  \n  \nfunction closePatientEditPanel()  \n{  \n  \n}  \nfunction openPatientEditPanel(shiftID,itemID)  \n{  \nvar shiftName=$m({  \nClassName:\"Nur.SHIFT.Service.ShiftBizV2\",  \nMethodName:\"GetShiftName\",  \nShiftType:shiftID  \n},false);  \nvar itemInfo=$cm({  \nClassName:\"Nur.SHIFT.Service.ShiftBizV2\",  \nMethodName:\"GetItemName\",  \nItemDR:itemID  \n},false);  \nvar itemName=itemInfo.name;  \nvar modalType=itemInfo.modal;  \nmodifiedItemDR=itemID;  \nmodifiedDate=tjDate;  \nmodifiedShiftType=shiftID;  \nif(modalType==\"C\")  \n{  \n$(\"#modalEditPatientInner\").empty();  \n$cm({  \n         ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n         MethodName: \"GetValidPatient\",  \n         WardID: wardID,  \n         TJDate: tjDate,  \n         ShiftType: shiftID,  \n         ItemDR: itemID  \n     },function(jsondata){  \n     originChecked=[],originPat=[];  \n     for(var i=0;i<jsondata.length;i++)  \n     {  \n     var data=jsondata[i];  \n     var check=data.checked==\"0\"?false:true  \n     if(check)  \n     {  \n     originChecked.push(data.value);  \n     originPat.push(data.text);  \n    }  \n     var checkbox=\"<input class='hisui-checkbox' name='cbp' type='checkbox' value='\"+data.value+\"' label='\"+data.text+\"' style='width: 200px;' id='cbp\"+data.value+\"' data-options='checked:\"+check+\"'>\"  \n     $(\"#modalEditPatientInner\").append(checkbox);  \n     $HUI.checkbox(\"#modalEditPatientInner input#cbp\"+data.value,{});  \n    }  \n    $(\"#modalEditPatient\").window({  \ntitle:shiftName+\"-\"+itemName  \n})  \n$(\"#modalEditPatient\").window(\"open\");  \n    });  \n}else  \n{  \n$(\"#mpcount\").val(\"\");  \n$(\"#mlabel\").text(itemName+\" \");  \n$(\"#modalEditPC\").window({  \ntitle:shiftName+\"-\"+itemName  \n});  \n$(\"#modalEditPC\").window(\"open\");  \n}  \n}  \n// 交班签名  \nfunction patientStatistics(){  \n$cm({  \n        ClassName: \"Nur.SHIFT.Service.ShiftBizV2\",  \n        MethodName: \"QueryGroupByItemDR\",  \n        WardID: wardID,  \n        TjDate: tjDate,  \n    },  \n    function (jsonData) {  \n        var columns = jsonData.columns;  \n  \n    columns[0].styler=function(value,row,index){  \nif(value.indexOf('白班')>-1){  \nreturn 'background-color:#EBF6FE;border-color:#0096F2;color:#0096F2,font-weight:bold'  \n}  \nreturn 'font-weight:bold;background-color:#f4f6f5;'  \n}  \n        $HUI.datagrid('#tableC',{  \n//fitColumns:true,  \ncolumns:[jsonData.columns],  \nsingleSelect:true,  \ndata:{  \nrows:jsonData.rows,  \n},  \n//title:'患者统计',  \nidField:'id',  \n//headerCls:'panel-header-gray',  \n//iconCls:'icon-sum',  \n  \nonDblClickCell:function(rowIndex, field, value)  \n{  \nvar row=$('#tableC').datagrid(\"getRows\")[rowIndex]  \nif(field==\"shiftName\")  \n{  \nvar id=row.id;  \nself.location.href = \"nur.shift.index.showAll.csp?WardID=\" + wardID + \"&TJDate=\" + tjDate + \"&ShiftType=\" + id  \n}else  \n{  \nvar shiftID=row.id  \nvar itemID=field.replace(\"item\",\"\")  \nopenPatientEditPanel(shiftID,itemID)  \n}  \n}  \n});  \n$('#tableC').datagrid(\"selectRecord\",shiftType)  \n        var signs=jsonData.signs  \n        var thisSign=signs[shiftType]  \n        $(\"#sign\").text(thisSign.sign);  \n        $(\"#sign2\").text(thisSign[\"sign2\"]);  \n    });  \n}  \n  \n// 打开修改记录弹窗  \nfunction openModifyLog(){  \n$('#modalModifyLog').dialog('open');  \nvar data=$.cm({  \nClassName:\"Nur.SHIFT.Service.ShiftBizBase\",  \nQueryName:\"QueryShiftType\",  \nDesc:\"\",  \nWardID:wardID,  \nTJDate:tjDate,  \nrows:99999  \n},false);  \nvar newData=data.rows;  \nnewData.unshift({value:\"\",text:$g(\"全部\")})  \n$HUI.combobox(\"#shift\",{  \npanelHeight:\"120\",  \nvalueField:\"value\",  \ntextField:\"text\",  \ndata:newData  \n});  \n$HUI.combobox(\"#operateType\",{  \nvalueField:\"value\",  \ntextField:\"text\",  \ndata:[{value:\"\",text:\"全部\"},{value:\"A\",text:\"新增\"},{value:\"M\",text:\"修改\"},{value:\"D\",text:\"删除\"},{value:\"H\",text:\"隐藏\"},{value:\"R\",text:\"恢复\"}]  \n});  \n// 获取统计区/中间区修改日志  \ninitModifyLogTable(0)  \ngetModifyLog(0,\"\");  \n// 修改日志-切换tab页  \n$HUI.tabs(\"#tabs\",  \n{  \nselected:0,  \nonSelect:function(title,index){  \nvar DataSource=\"\";  \nif(index==1){  \n$(\".operateType\").show();  \nDataSource=$(\"#operateType\").combobox(\"getValue\");  \n}else{  \n$(\".operateType\").hide();  \n}  \ninitModifyLogTable(index)  \ngetModifyLog(index,DataSource)  \n}  \n});  \n}  \n// 保存修改日志  \nfunction saveModifyLog(ShiftType,BedCode,EpisodeID,OldItemDR,NowItemDR,OldCount,NowCount,OldContent,NowContent,DataType,DataSource){  \nvar modifyData={  \nShiftType:ShiftType,  \nBedCode:BedCode,  \nEpisodeID:EpisodeID,  \nOldItemDR:OldItemDR,  \nNowItemDR:NowItemDR,  \nOldCount:OldCount,  \nNowCount:NowCount,  \nOldContent:OldContent,  \nNowContent:NowContent,  \nDataType:DataType,  \nDataSource:DataSource,  \nUserID:session[\"LOGON.USERID\"],  \nWardID:wardID  \n}  \n$.cm({  \nClassName:\"Nur.SHIFT.Service.ShiftBizV2\",  \nMethodName:\"SaveModifyLog\",  \nsaveJson:JSON.stringify(modifyData)  \n},function testget(result){  \nif(result==0){  \n//$.messager.popover({ msg: \"保存成功！\", type:'success' });  \n}else{  \n$.messager.popover({ msg: result, type:'error' });  \n}  \n})  \n}  \n// 获取修改日志列表  \nfunction initModifyLogTable(tabIndex){  \nvar columns=[[  \n{field:\"ShiftName\",title:\"班次名称\",width:80},  \n{field:\"BedCode\",title:\"床号\",width:50,hidden:tabIndex===0 ? true: false},  \n{field:\"PatName\",title:\"姓名\",width:100,hidden:tabIndex===0 ? true: false},  \n{field:\"OldItemName\",title:tabIndex===0 ? \"交班项目\" : \"原交班项目\",width:120},  \n{field:\"NowItemName\",title:\"新交班项目\",width:120,hidden:tabIndex===0 ? true: false},  \n{field:\"OldCount\",title:\"原统计数\",width:80,hidden:tabIndex===0 ? false: true,formatter: function(value, row, index){  \nif(parseInt(value)>0){  \nreturn \"<a class='hisui-tooltip' id='oldCount\"+index+\"' style='cursor:pointer;text-decoration-line:underline;'>\"+value+\"</a>\"  \n}else{  \nreturn value;  \n}  \n}},  \n{field:\"NowCount\",title:\"新统计数\",width:80,hidden:tabIndex===0 ? false: true,formatter: function(value, row, index){  \nif(parseInt(value)>0){  \nreturn \"<a class='hisui-tooltip' id='nowCount\"+index+\"' style='cursor:pointer;text-decoration-line:underline;'>\"+value+\"</a>\"  \n}else{  \nreturn value;  \n}  \n}},  \n{field:\"OldContent\",title:\"原交班内容\",width:200,formatter:function(value,row,index){  \nreturn row.DataType==\"C\" ? \"\" : '<span title=\"'+value+'\" style=\"display:inline-block;width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis\">'+value+'</span>';  \n}},  \n{field:\"NowContent\",title:\"新交班内容\",width:200,formatter:function(value,row,index){  \nreturn row.DataType==\"C\" ? \"\" : '<span title=\"'+value+'\" style=\"display:inline-block;width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis\">'+value+'</span>';  \n}},  \n{field:\"DataSource\",title:\"操作类型\",width:80,hidden:tabIndex===0 ? true: false},  \n{field:\"CreateDTime\",title:\"操作时间\",width:140},  \n{field:\"UserName\",title:\"操作人\",width:100}  \n]];  \n$(\"#dgLog\"+tabIndex).datagrid({  \nfit:true,  \ntoolbar:[],  \ncolumns: columns,  \nloadMsg: \"正在加载中...\"      \n});  \n}  \nfunction getModifyLog(tabIndex,DataSource){  \nvar DataType=tabIndex===0 ? \"CM\" : \"D\";  \nvar StartDate=$(\"#startDate\").datebox(\"getValue\");  \nvar EndDate=$(\"#endDate\").datebox(\"getValue\");  \nvar ShiftDR=$(\"#shift\").combobox(\"getValue\");  \n$.cm({  \nClassName:\"Nur.SHIFT.Service.ShiftBizV2\",  \nQueryName:\"GetModifyLog\",  \nWardID:wardID,  \nDataType:DataType,  \nStartDate:StartDate,  \nEndDate:EndDate,  \nShiftType:ShiftDR,  \nDataSource:DataSource,  \nrows:99999  \n},function(data){  \n$(\"#dgLog\"+tabIndex).datagrid(\"loadData\",data);  \nvar rows=data.rows;  \nif(rows.length > 0){  \nfor(var i = 0; i < rows.length; i++){  \nvar oldCount = parseInt(rows[i].OldCount);  \nif(oldCount > 0){  \nvar html = '<div class=\"shiftPatients\" id=\"oldPatients' + i + '\">'+rows[i].OldContent+'</div>';  \n$HUI.tooltip(\"#oldCount\" + i,{content: html});  \n}  \nvar nowCount = parseInt(rows[i].NowCount);  \nif(nowCount > 0){  \nvar html = '<div class=\"shiftPatients\" id=\"nowPatients' + i + '\">'+rows[i].NowContent+'</div>';  \n$HUI.tooltip(\"#nowCount\" + i,{content: html});  \n}  \n}  \n}  \n});  \n}  \n// 查询修改日志  \nfunction searchModifyLog(){  \nvar tab = $('#logList #tabs').tabs('getSelected');  \nvar index = $('#logList #tabs').tabs('getTabIndex',tab);  \nvar DataSource=index===0 ? \"\" : $(\"#operateType\").combobox(\"getValue\");  \ngetModifyLog(index,DataSource);  \n}  \n//function showPatients(patientInfo,index,type){  \n// var obj = {  \n// title: \"对应患者\",  \n// context: \"<div>\" + patientInfo + \"</div>\"  \n// };  \n// var display = $(\"#\"+type+\"Patients\"+index).parents(\".webui-popover\").css(\"display\");  \n// if(display != \"block\"){  \n// $(\"#\"+type+\"Count\"+index).popover('show');  \n// if(!display){  \n// $(\"#\"+type+\"Patients\"+index).hstep({  \n// stepWidth: 140,  \n// currentInd: data.length,  \n// items: items  \n// });  \n// }  \n// }else{  \n// $(\"#exeRecord-\" + code + index).popover('hide');  \n// }  \n//}  \n  \n$(function () {  \n// 计算交班项目的高度  \nvar wrapHeight = $(\"#main\").height();  \nvar dateArea=document.getElementsByClassName(\"dateArea\")[0].offsetHeight;  \nvar shiftHeight = 0;  \nvar curHeight = 0;  \nvar timer = setInterval(function(){  \nshiftHeight = document.getElementsByClassName(\"shiftArea\")[0].offsetHeight;  \nif(curHeight != shiftHeight){  \ncurHeight = shiftHeight  \n}else if((curHeight > 0)&&(shiftHeight>10)){  \n  \nvar midHeight = document.getElementsByClassName(\"midArea\")[0].offsetHeight;  \nvar height = wrapHeight - dateArea - shiftHeight - midHeight;  \n$(\"#bottom,#dg1\").css(\"height\", height + 'px')  \nreloadDetail(\"\",\"\",0);  \nconsole.log(shiftHeight)  \nclearInterval(timer);  \n}  \n},300);  \n  \nvar CurWardsummary=\"\"  \nif($(\"#wardsummary\"))  \n{  \n$(\"#wardsummary\").focus(function(){  \n   CurWardsummary=$.trim($(this).val());  \n});  \n$(\"#wardsummary\").blur(function(){  \nvar itemDR=$(this).data(\"item\");  \n   saveSummary(CurWardsummary,itemDR);  \n});  \n}  \n    $(\"#rebuild\").on(\"click\", function () {  \n        $(\"#modalRebuild\").window('open');  \n    });  \n    $HUI.combobox(\"#nurseBox\",{  \nvalueField:'id',  \ntextField:'text',  \nmultiple:true,  \nrowStyle:'checkbox', //显示成勾选行形式  \nselectOnNavigation:false,  \neditable:false,  \nurl:$URL+\"?ClassName=Nur.SHIFT.Service.ShiftBizV2&MethodName=QueryWardNurse&WardID=\"+wardID  \n});  \n$HUI.combobox(\"#nurseBox2\",{  \nvalueField:'id',  \ntextField:'text',  \nmultiple:true,  \nrowStyle:'checkbox', //显示成勾选行形式  \nselectOnNavigation:false,  \neditable:false,  \nurl:$URL+\"?ClassName=Nur.SHIFT.Service.ShiftBizV2&MethodName=QueryWardNurse&WardID=\"+wardID  \n});  \n    $HUI.radio(\"[name='radioshift']\", {  \n        onChecked: function (e, value) {  \ncheckedShiftDR = $(e.target).val()  \n        }  \n    });  \n    $('#datecombo').datebox().datebox('calendar').calendar({  \n        validator: function (date) {  \n            var curr_time = new Date()  \n            var d1 = new Date(curr_time.getFullYear(), curr_time.getMonth(), curr_time.getDate());  \n            return d1 >= date;  \n        }  \n    });  \n    $('#datecombo').datebox({  \n        onSelect: function (date) {  \n            var dateHtml = date.getFullYear() + \"-\" + (date.getMonth() + 1) + \"-\" + date.getDate()  \n            self.location.href = \"nur.shift.index.showAll.csp?WardID=\" + wardID + \"&TJDate=\" + dateHtml  \n        }  \n    });  \n    $('#datecombo').datebox(\"setValue\", tjDate);  \n    $('#rightClickMenu').menu()  \n      \n    patientStatistics();  \n      \n    // 修改日志-默认开始和结束日期为当天交班日期  \n    $(\"#startDate,#endDate\").datebox(\"setValue\",tjDate);  \n});  \n</script>  \n</html>\n```","x":-2160,"y":-634,"width":1120,"height":694},
		{"id":"ce511c03eea6f9b7","type":"text","text":"```\nClass Nur.Custom.NeedUnit.NeedUnit231010 Extends %RegisteredObject\n{\n\n/// 获取指定病区，指定日期的班次\n/// ##class(Nur.Custom.NeedUnit.NeedUnit231010).GetShiftConfig(39,\"2023-10-11\")\nClassMethod GetShiftConfig(WardId, DateH)\n{\n\t\n\t//获得交班业务数据 id\n\ts dateL = ##Class(websys.Conversions).DateHtmlToLogical(DateH)\n\ts shiftRecordRid = ##class(Nur.SHIFT.Service.ShiftBizV2).GetMainDR(WardId,dateL)\n\t//获得班次\n\ts resule = \"\"\n\ts shiftRecordSid = \"0\" f{\n\t\ts shiftRecordSid = $o(^Nur.SHIFT.ShiftRecord(shiftRecordRid,\"C\",shiftRecordSid))\n\t\tq:shiftRecordSid=\"\"\n\t\ts shiftRecordId = shiftRecordRid_\"||\"_shiftRecordSid\n\t\ts shiftId = $p(^Nur.SHIFT.ShiftRecord(shiftRecordRid,\"C\",shiftRecordSid),\"^\",1)\n\t\ts shiftName = $p(^CF.NUR.SHIFT.ExchangeSettingV2($p(shiftId,\"||\",1),\"class\",$p(shiftId,\"||\",2)),\"^\",7)\n\t\ts val = shiftRecordId_\"#\"_shiftName\n\t\ts resule = $s(resule=\"\":val,1:resule_\"^\"_val)\n\t}\n\tq resule\n}\n\n/// 保存交班内容\n/// ##class(Nur.Custom.NeedUnit.NeedUnit231010).SaveContent(\"9844||1||4\",\"222221\")\nClassMethod SaveContent(ShiftRecordId, Value)\n{\n\ts ^temp(\"SaveContent\")=$lb(ShiftRecordId, Value)\n\t//q \"0\"\n\t//##class(Nur.SHIFT.Service.ShiftBizV2).SavePatEdit(MainRecordDR,ClsSub,PatSub,Key,Value)\n\ts shiftRecordRid = $p(ShiftRecordId,\"||\",1)\n\ts shiftRecordSid = $p(ShiftRecordId,\"||\",2)\n\ts ShiftRecordEid = $p(ShiftRecordId,\"||\",3)\n\t\n\tq ##class(Nur.SHIFT.Service.ShiftBizBase).SavePatRecordField(shiftRecordRid,shiftRecordSid,ShiftRecordEid,\"SPRContent\",Value)\n}\n\n}\n\n```","x":-2040,"y":73,"width":1034,"height":480},
		{"id":"5864e05261553a85","type":"text","text":"获得班次","x":-405,"y":-100,"width":250,"height":60},
		{"id":"7f6a8ea6d53929c9","type":"text","text":"界面增加列","x":-405,"y":0,"width":250,"height":60},
		{"id":"3f3c1b15e16b7b84","type":"text","text":"修改保存方法","x":-405,"y":380,"width":250,"height":60},
		{"id":"3156b28f29dd0d6d","type":"text","text":"nur.shift.index.showAll.csp","x":-100,"y":-210,"width":250,"height":60},
		{"id":"17346d8bda82948c","type":"text","text":"291649269  \n123456dh","x":-100,"y":-300,"width":250,"height":60},
		{"id":"1e1465101192fd0d","type":"text","text":"删除","x":-100,"y":60,"width":250,"height":60},
		{"id":"3cc0b8b937c9aaa1","type":"text","text":"","x":-100,"y":140,"width":250,"height":60},
		{"id":"2afb7d95bd23a74b","type":"text","text":"afterEdit","x":-100,"y":380,"width":250,"height":60},
		{"id":"344d1073e8022dd5","type":"text","text":"修改获取数据方法","x":-405,"y":220,"width":250,"height":60},
		{"id":"ef949ea7db1ec9ae","type":"text","text":"loadDetailData2","x":-100,"y":220,"width":250,"height":60}
	],
	"edges":[
		{"id":"3e817bd270200809","fromNode":"725192ab3065ebad","fromSide":"left","toNode":"a340ef5a9d1d186d","toSide":"right"},
		{"id":"80ccc996ec10b3aa","fromNode":"62e5bbf6fd3e5e6b","fromSide":"left","toNode":"ce511c03eea6f9b7","toSide":"right"}
	]
}