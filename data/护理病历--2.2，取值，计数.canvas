{
	"nodes":[
		{"id":"24a3a56b47b2a113","type":"text","text":"方法","x":-331,"y":-200,"width":250,"height":60},
		{"id":"9d8d3a40873c5c00","type":"text","text":"```js\nClass Nur.Custom.NeedUnit.NeedUnit230829 Extends %RegisteredObject\n{\n\n/// 指定日期范围内，不同统计的病人计数\n/// 输液人次【提取医嘱里开了输夜的患者人次，多组输液只计1次】\n/// 跌倒--【提取每日新入患者跌倒评估表评估为高风险的人数】\n/// 跌倒--【提取跌倒评估表最近—次评估为高风险的人数】\n/// 跌倒--【提取病案首页上诊断为股骨粗隆间骨折或股骨颈骨折的人数，重复诊断只取一项】\n/// 压力--【提取病案首页附页上:住院期间发生，压疮分期2期及以上发生例数】\n/// 压力--【提取每日新入患者跌倒每日新入患者压力性损伤评估表评估为高风险的人数】\n/// 压力--【提取压力性损伤评估表最近—次评估为高风险的人数】\n/// VTE--【每日出院患者中，有VTE风险评估的患者,提取VTE风险评估表数据】\n/// VTE--【风险评估表上有预防措施的人次】\n/// VTE--【VTE风险评估为高危/中危的出院患者人次】\n/// 营养--【营养评估的住院患者例数】\n/// 输注反应发生例数【提取病案首页上，输液反应:有选项的总例次】\n/// 输血反应发生例数【提取出院患者中，病案首贡上:输而反应:是选项例数】\n/// d ##class(%ResultSet).RunQuery(\"Nur.Custom.NeedUnit.NeedUnit230829\",\"QueryNurMpNum\",\"2023-08-28\",\"2023-09-01\",\"vte1\")\nQuery QueryNurMpNum(StartDate, EndDate, DebuggerCode = \"\") As websys.Query(ROWSPEC = \"shuye,dieDao1,dieDao2,dieDao3,yali1,yali2,yali3,vte1,vte2,vte3,yy1,shuzhu,shuxue\") [ SqlProc ]\n{\n}\n\nClassMethod QueryNurMpNumExecute(ByRef qHandle As %Binary, StartDate, EndDate, DebuggerCode = \"\") As %Status\n{\n\tset repid=$I(^CacheTemp)\n \ts ind=1\n \ts qHandle=$lb(0,repid,0)\n\t//以下是实例代码\n\ts (shuye,dieDao1,dieDao2,dieDao3,yali1,yali2,yali3,vte1,vte2,vte3,yy1,shuzhu,shuxue)=0\n\t//获取跌倒儿科跌倒 ^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,id)\n\ts TCIndentityU = \"31A16CCFE29647038F8AF4FB89A8DBF0\"\n\td ##class(Nur.Custom.NeedUnit.NeedUnit230829).GetEpisodeNurMpSort(TCIndentityU,StartDate,EndDate)\n\ts episodeId = \"\" f{\n\t\ts episodeId = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId))\n\t\tq:episodeId=\"\"\n\t\t//跌倒1  \n\t\ts inHospDateL = $p($g(^PAADM(episodeId)),\"^\",6) //入院日期\n\t\ts time = \"\" f{\n\t\t\ts time = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,inHospDateL,time))\n\t\t\tq:time=\"\"\n\t\t\ts id = \"\" f{\n\t\t\t\ts id = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,inHospDateL,time,id))\n\t\t\t\tq:id=\"\"\n\t\t\t\ts dieDao1Value = $list(^NurMp.DHCTempMultDataD(id),26)\n\t\t\t\ti dieDao1Value>=12{\n\t\t\t\t\ti '$d(num(\"dieDao1\",episodeId)) {\n\t\t\t\t\t\ts dieDao1 = dieDao1 + 1\n\t\t\t\t\t\td ..OutPutPatient(episodeId,dieDao1Value,DebuggerCode,\"dieDao1\")\n\t\t\t\t\t}\n\t\t\t\t\ts num(\"dieDao1\",episodeId)=\"\"\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t//跌倒2\n\t\ts date = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,\"\"),-1)\n\t\ts time = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time),-1)\n\t\ts id = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,\"\"),-1)\n\t\tq:id=\"\"\n\t\ts dieDao2Value = $list(^NurMp.DHCTempMultDataD(id),26)\n\t\ti dieDao2Value>=12{\n\t\t\ti '$d(num(\"dieDao2\",episodeId)) {\n\t\t\t\ts dieDao2 = dieDao2 + 1\n\t\t\t\td ..OutPutPatient(episodeId,dieDao2Value,DebuggerCode,\"dieDao2\")\n\t\t\t}\n\t\t\ts num(\"dieDao2\",episodeId)=\"\"\n\t\t}\n\n\n\t}\n\t//获取跌倒成人跌倒 ^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,id)\n\ts TCIndentityU = \"1A3638CA018D494885BC0CB7F469E1FB\"\n\td ##class(Nur.Custom.NeedUnit.NeedUnit230829).GetEpisodeNurMpSort(TCIndentityU,StartDate,EndDate)\n\ts episodeId = \"\" f{\n\t\ts episodeId = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId))\n\t\tq:episodeId=\"\"\n\t\t//跌倒1\n\t\ts inHospDateL = $p($g(^PAADM(episodeId)),\"^\",6) //入院日期\n\t\ts time = \"\" f{\n\t\t\ts time = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,inHospDateL,time))\n\t\t\tq:time=\"\"\n\t\t\ts id = \"\" f{\n\t\t\t\ts id = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,inHospDateL,time,id))\n\t\t\t\tq:id=\"\"\n\t\t\t\ts dieDao1Value = $list(^NurMp.DHCTempMultDataD(id),31)\n\t\t\t\ti dieDao1Value=\"高风险\"{\n\t\t\t\t\ti '$d(num(\"dieDao1\",episodeId)) {\n\t\t\t\t\t\ts dieDao1 = dieDao1 + 1\n\t\t\t\t\t\td ..OutPutPatient(episodeId,dieDao1Value,DebuggerCode,\"dieDao1\")\n\t\t\t\t\t}\n\t\t\t\t\ts num(\"dieDao1\",episodeId)=\"\"\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t//跌倒2\n\t\ts date = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,\"\"),-1)\n\t\ts time = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time),-1)\n\t\ts id = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,\"\"),-1)\n\t\tq:id=\"\"\n\t\ts dieDao2Value = $list(^NurMp.DHCTempMultDataD(id),31)\n\t\ti dieDao2Value=\"高风险\"{\n\t\t\ti '$d(num(\"dieDao2\",episodeId)) {\n\t\t\t\ts dieDao2 = dieDao2 + 1\n\t\t\t\td ..OutPutPatient(episodeId,dieDao2Value,DebuggerCode,\"dieDao2\")\n\t\t\t}\n\t\t\ts num(\"dieDao2\",episodeId)=\"\"\n\t\t}\n\n\t}\n\t//获取压力 ^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,id)\n\ts TCIndentityU = \"E903493B50EF4824BCE67730E29E86EA\"\n\t//获取压力idStr\n\td ##class(Nur.Custom.NeedUnit.NeedUnit230829).GetEpisodeNurMpSort(TCIndentityU,StartDate,EndDate)\n\ts episodeId = \"\" f{\n\t\ts episodeId = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId))\n\t\tq:episodeId=\"\"\n\t\t// 统计压力2\n\t\ts inHospDateL = $p($g(^PAADM(episodeId)),\"^\",6) //入院日期\n\t\ti (inHospDateL>=StartDate)&&(inHospDateL<=EndDate){\n\t\t\ti '$d(num(\"yali2\",episodeId)) {\n\t\t\t\ts yali2 = yali2 + 1\n\t\t\t\td ..OutPutPatient(episodeId,\"出院\",DebuggerCode,\"yali2\")\n\t\t\t}\n\t\t\ts num(\"yali2\",episodeId)=\"\"\n\t\t}\n\t\t// 统计压力3\n\t\ts date = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,\"\"),-1)\n\t\ts time = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,\"\"),-1)\n\t\ts id = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,\"\"),-1)\n\t\ts yali3Value = $list(^NurMp.DHCTempMultDataD(id),34)\n\t\ti yali3Value<=9{\n\t\t\ti '$d(num(\"yali3\",episodeId)) {\n\t\t\t\ts yali3 = yali3 + 1\n\t\t\t\td ..OutPutPatient(episodeId,yali3Value,DebuggerCode,\"yali3\")\n\t\t\t}\n\t\t\ts num(\"yali3\",episodeId)=\"\"\n\t\t}\n\t}\n\t//获取VTE ^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,id)\n\ts TCIndentityU = \"99B1EE0730DE4692A88BF1D1E41CD218\"\n\td ##class(Nur.Custom.NeedUnit.NeedUnit230829).GetEpisodeNurMpSort(TCIndentityU,StartDate,EndDate)\n\ts episodeId = \"\" f{\n\t\ts episodeId = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId))\n\t\tq:episodeId=\"\"\n\t\t//是否出院患者\n\t\ts VisitStatusCode = $p(^PAADM(episodeId),\"^\",20)\n\t\t//统计vte1\n\t\ti VisitStatusCode=\"D\"{\n\t\t\ti '$d(num(\"vte1\",episodeId)) {\n\t\t\t\ts vte1 = vte1 + 1\n\t\t\t\td ..OutPutPatient(episodeId,VisitStatusCode,DebuggerCode,\"vte1\")\n\t\t\t}\n\t\t\ts num(\"vte1\",episodeId) = \"\" \n\t\t}\n\t\t//统计vte2\n\t\ts date = \"\" f{\n\t\t\ts date = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date))\n\t\t\tq:date=\"\"\n\t\t\ts time = \"\" f{\n\t\t\t\ts time = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time))\n\t\t\t\tq:time=\"\"\n\t\t\t\ts id = \"\" f{\n\t\t\t\t\ts id = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,id))\n\t\t\t\t\tq:id=\"\"\n\t\t\t\t\ts yufangValue = $list(^NurMp.DHCTempMultDataD(id),30)\n\t\t\t\t\t//b\n\t\t\t\t\ti yufangValue'=\"[]\" {\n\t\t\t\t\t\ti '$d(num(\"vte2\",episodeId)) {\n\t\t\t\t\t\t\ts vte2 = vte2 + 1\n\t\t\t\t\t\t\td ..OutPutPatient(episodeId,yufangValue,DebuggerCode,\"vte2\")\n\t\t\t\t\t\t}\n\t\t\t\t\t\ts num(\"vte2\",episodeId)=\"\"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t//统计vte3\n\t\ts date = \"\" f{\n\t\t\ts date = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date))\n\t\t\tq:date=\"\"\n\t\t\ts time = \"\" f{\n\t\t\t\ts time = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time))\n\t\t\t\tq:time=\"\"\n\t\t\t\ts id = \"\" f{\n\t\t\t\t\ts id = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,id))\n\t\t\t\t\tq:id=\"\"\n\t\t\t\t\ts fengxianText = $list(^NurMp.DHCTempMultDataD(id),28)\n\t\t\t\t\t//b\n\t\t\t\t\ti fengxianText'=\"[]\" {\n\t\t\t\t\t\ts fengxianText = ..getText(fengxianText,\"\",\"\")\n\t\t\t\t\t\ti \"^中危^高危^\"[fengxianText {\n\t\t\t\t\t\ti '$d(num(\"vte3\",episodeId)) {\n\t\t\t\t\t\t\ts vte3 = vte3 + 1\n\t\t\t\t\t\t\td ..OutPutPatient(episodeId,fengxianText,DebuggerCode,\"vte3\")\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\ts num(\"vte3\",episodeId)=\"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t//获取营养 ^||EpisodeNurMpSort(TCIndentityU,episodeId,date,time,id)\n\ts TCIndentityU = \"16F308C08D324AC8B4C2863D4A029557\"\n\td ##class(Nur.Custom.NeedUnit.NeedUnit230829).GetEpisodeNurMpSort(TCIndentityU,StartDate,EndDate)\n\ts episodeId = \"\" f{\n\t\ts episodeId = $o(^||EpisodeNurMpSort(TCIndentityU,episodeId))\n\t\tq:episodeId=\"\"\n\t\t//营养1\n\t\ti '$d(num(\"yy1\",episodeId)) {\n\t\t\ts yy1 = yy1 + 1\n\t\t\td ..OutPutPatient(episodeId,\"有数据\",DebuggerCode,\"yy1\")\n\t\t}\n\t}\n\tb\n\td OutQueryNurMpNum\n\tSet qHandle=$lb(0,repid,0)\n\tQuit $$$OK\nOutQueryNurMpNum\n\tset Data=$lb(shuye,dieDao1,dieDao2,dieDao3,yali1,yali2,yali3,vte1,vte2,vte3,yy1,shuzhu,shuxue)\n \tSet ^CacheTemp(repid,ind)=Data\n \tSet ind=ind+1\n\tquit\n}\n\n/// 压力：##class(Nur.Custom.NeedUnit.NeedUnit230829).GetEpisodeNurMpSort(\"E903493B50EF4824BCE67730E29E86EA\",\"2023-08-30\",\"2023-09-01\")\nClassMethod GetEpisodeNurMpSort(TCIndentityU, StartDate, EndDate)\n{\n\ts startDateL = ##Class(websys.Conversions).DateHtmlToLogical(StartDate)\n\ts endDateL = ##Class(websys.Conversions).DateHtmlToLogical(EndDate)\n\tf date=startDateL:1:endDateL{\n\t\ts DateH = ##Class(websys.Conversions).DateLogicalToHtml(date)\n\t\ts time = \"\" f{\n\t\t\ts time = $O(^NurMp.DHCTempMultDataI(\"TypDatTim\",\" \"_TCIndentityU,\" \"_DateH,time))\n\t\t\tq:time=\"\"\n\t\t\ts id = \"\" f{\n\t\t\t\ts id = $O(^NurMp.DHCTempMultDataI(\"TypDatTim\",\" \"_TCIndentityU,\" \"_DateH,time,id))\n\t\t\t\tq:id=\"\"\n\t\t\t\ts cancelUser = $list(^NurMp.DHCTempMultDataD(id),75)\n\t\t\t\tcontinue:cancelUser'=\"\"\n\t\t\t\ts episodeId = $list(^NurMp.DHCTempMultDataD(id),7)\n\t\t\t\ts time2 = $tr(time,\" \",\"\")\n\t\t\t\ts timeL = ##Class(websys.Conversions).TimeHtmlToLogical(time2)\n\t\t\t\ts ^||EpisodeNurMpSort(TCIndentityU,episodeId,date,timeL,id)=\"\"\n\t\t\t}\n\t\t}\n\t}\n}\n\nClassMethod GetItemAndValidValue(TCIndentityU, Type)\n{\n\t//VTE单子\n\tif (TCIndentityU=\"99B1EE0730DE4692A88BF1D1E41CD218\"){\n\t\tif (Type=\"Item\"){\n\t\t\tq \"Item21\"\n\t\t}else{\n\t\t\tq \"^中危^高危^\"\n\t\t}\n\t}\n}\n\n/// 指定日期，有填写这个数据，且指定值满足条件的患者\n/// ##class(Nur.Custom.NeedUnit.NeedUnit230829).GetPatNum(\"99B1EE0730DE4692A88BF1D1E41CD218\",\"2023-08-29\",\"2023-08-29\")\nClassMethod GetPatNum(TCIndentityU, StartDate, EndDate)\n{\n\t// Index TypDatTim On (EmrCode, CareDate, CareTime);\n\ts Item = ..GetItemAndValidValue(TCIndentityU,\"Item\")\n\ts ValidValue = ..GetItemAndValidValue(TCIndentityU,\"ValidValue\")\n\ts num = 0\n\ts startDateL = ##Class(websys.Conversions).DateHtmlToLogical(StartDate)\n\ts endDateL = ##Class(websys.Conversions).DateHtmlToLogical(EndDate)\n\tf date=startDateL:1:endDateL{\n\t\ts DateH = ##Class(websys.Conversions).DateLogicalToHtml(date)\n\t\ts time = \"\" f{\n\t\t\ts time = $O(^NurMp.DHCTempMultDataI(\"TypDatTim\",\" \"_TCIndentityU,\" \"_DateH,time))\n\t\t\tq:time=\"\"\n\t\t\ts id = \"\" f{\n\t\t\t\ts id = $O(^NurMp.DHCTempMultDataI(\"TypDatTim\",\" \"_TCIndentityU,\" \"_DateH,time,id))\n\t\t\t\tq:id=\"\"\n\t\t\t\ts cancelUser = $list(^NurMp.DHCTempMultDataD(id),75)\n\t\t\t\tcontinue:cancelUser'=\"\"\n\t\t\t\ts obj = ##class(NurMp.DHCTempMultData).%OpenId(id)\n\t\t\t\ts episodeId = $ZOBJPROPERTY(obj,\"EpisodeId\")\n\t\t\t\ts value = $ZOBJPROPERTY(obj,Item)\n\t\t\t\ts value = ..getText(value,\"\",\"\")\n\t\t\t\t\n\t\t\t\t// 不满足条件的\n\t\t\t\tcontinue:ValidValue'[value\n\t\t\t\t\n\t\t\t\ts sort(episodeId,id) = \"\"\n\t\t\t\tcontinue:$d(sort(\"Set\",episodeId))\n\t\t\t\ts personId = $p(^PAADM(episodeId),\"^\",1)\n\t\t\t\ts regNo = $p(^PAPER(personId,\"PAT\",1),\"^\",1)\n\t\t\t\ts sort(\"Set\",episodeId,regNo) = \"\"\n\t\t\t\ts num = num + 1\n\t\t\t\t\n\t\t\t}\n\t\t}\n\t}\n\n\tb\n\tq num\n}\n\nClassMethod getText(Str, valItemsSplitString, Itmlb)\n{\n\ti Str=\"[]\" q \"\"\n\ti Str'[\"[{\" q \"\"\n\ts ItmlbValue=\",\"\n\ti (valItemsSplitString'=\"\")&&(##class(NurMp.ErrorMsg).Encode(valItemsSplitString)'=\"\")\n\t{\n\t\ts ItmlbValue=valItemsSplitString.GetAt(Itmlb)\n\t\ti ItmlbValue=\"\" s ItmlbValue=\",\"\n\t}\n\ts ret=\"\"\n\ts itemValue=##class(NurMp.Json).Decode(Str)\n\ts itemValuekey=itemValue.Next(\"\")\n\twhile (itemValuekey'=\"\")\n\t{\n\t\ts Text=itemValue.GetAt(itemValuekey).GetAt(\"Text\")\n\t\ti ret=\"\"  s ret=Text\n\t\te  s ret=ret_ItmlbValue_Text\n\t\ts itemValuekey=itemValue.Next(itemValuekey)\n\t}\n\tq ret\n}\n\nClassMethod OutPutPatient(episodeId, value, debuggerCode, code)\n{\n\tif (debuggerCode=code){\n\t\ts personId = $p(^PAADM(episodeId),\"^\",1)\n\t\ts regNO = $p(^PAPER(personId,\"PAT\",1),\"^\",1)  \n\t\ts patName = $p(^PAPER(personId,\"ALL\"),\"^\",1)\n\t\ts value = ..getText(value,\"\",\"\")\n\t\tw regNO_\" \"_patName_\"  \"_value,!\n\t}\n}\n\n}\n\n```","x":-81,"y":-220,"width":983,"height":789}
	],
	"edges":[]
}